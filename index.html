<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Imobiliário de Luxo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* CSS Incorporado para o sistema de arquivo único */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');


        :root {
            --primary-color: #D4AF37;       /* Dourado Clássico */
            --secondary-color: #2C3E50;     /* Azul Ardósia / Grafite */
            --accent-color: #3498DB;        /* Azul Vibrante para Ações */
            --background-color: #F4F6F9;    /* Cinza Muito Claro */
            --surface-color: #FFFFFF;       /* Branco */
            --text-color: #34495E;          /* Cinza Escuro */
            --text-light-color: #FFF;
            --danger-color: #E74C3C;        /* Vermelho Suave */
            --success-color: #2ECC71;      /* Verde Suave */
            --warning-color: #F39C12;       /* Laranja Suave */
            --font-family: 'Montserrat', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
        }

        header {
            background-color: var(--secondary-color);
            color: var(--text-light-color);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            flex-shrink: 0;
        }

        .logo-container { display: flex; align-items: center; gap: 1rem; }
        #header-logo { max-height: 50px; border-radius: 5px; object-fit: contain; }
        .broker-info h1 { font-size: 1.2rem; font-weight: 600; }
        .broker-info p { font-size: 0.9rem; opacity: 0.8; }

        nav { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .nav-btn {
            background: none;
            border: none;
            color: var(--text-light-color);
            padding: 0.8rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            font-family: var(--font-family);
            border-radius: 5px;
            transition: background-color 0.3s, color 0.3s;
        }
        .nav-btn:hover { background-color: rgba(255,255,255,0.1); }
        .nav-btn.active { background-color: var(--primary-color); color: var(--secondary-color); font-weight: 700; }
        .nav-btn i { margin-right: 8px; }

        .header-tools .calculator-link {
            color: var(--text-light-color);
            font-size: 1.5rem;
            text-decoration: none;
            transition: color 0.3s;
        }
        .header-tools .calculator-link:hover { color: var(--primary-color); }

        main {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .panel { display: none; animation: fadeIn 0.5s; }
        .panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 1.5rem;
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }

        .toolbar { display: flex; flex-wrap: wrap; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
        input[type="text"], input[type="url"], input[type="number"], input[type="date"], input[type="time"], input[type="email"], select, textarea {
            padding: 0.8rem;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1rem;
            font-family: var(--font-family);
            flex-grow: 1;
        }
        .toolbar > input[type="text"] {
             min-width: 250px;
        }

        .btn-primary, .btn-secondary, .btn-danger, .btn-link, .btn-success {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            font-family: var(--font-family);
            text-align: center;
            white-space: nowrap;
        }
        .btn-primary { background-color: var(--primary-color); color: var(--secondary-color); }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-secondary { background-color: var(--secondary-color); color: var(--text-light-color); }
        .btn-secondary:hover { filter: brightness(1.3); }
        .btn-danger { background-color: var(--danger-color); color: var(--text-light-color); }
        .btn-danger:hover { filter: brightness(1.1); }
        .btn-success { background-color: var(--success-color); color: var(--text-light-color); }
        .btn-success:hover { filter: brightness(1.1); }
        .btn-link { background: none; color: var(--secondary-color); text-decoration: underline; padding: 0; }
        button i, a i { margin-right: 8px; }

        .table-container {
            background-color: var(--surface-color);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #eee; }
        td { white-space: normal; word-break: break-word; }
        th { white-space: nowrap; }
        th { background-color: #f8f9fa; font-weight: 600; color: var(--secondary-color); }
        tbody tr:hover { background-color: #f1f1f1; }
        .action-buttons { display:flex; gap: 0.8rem; white-space: nowrap; }
        .action-buttons button, .action-buttons a { background: none; border: none; cursor: pointer; font-size: 1.1rem; color: var(--secondary-color); padding: 0; }
        .action-buttons button:hover, .action-buttons a:hover { color: var(--primary-color); }

        .funnel-filters { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .funnel-filter-btn {
            background-color: #e0e0e0;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .funnel-filter-btn.active { background-color: var(--secondary-color); color: white; }

        .settings-grid, .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
        }
        
        /* ===== SEÇÃO FINANCEIRA REESTRUTURADA ===== */
        .financial-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .financial-panel-header h2 { margin-bottom: 0; }
        .financial-panel-header .header-buttons { display: flex; gap: 1rem; flex-wrap: wrap; }
        .financial-grid-container {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .financial-card {
            background-color: var(--surface-color);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            grid-column: span 12; /* Padrão para telas pequenas */
        }
        .financial-card h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: var(--text-color);
            opacity: 0.9;
            font-weight: 600;
        }
        .metric-card-content { display: flex; align-items: center; gap: 1.5rem; }
        .metric-icon {
            font-size: 2.5rem; color: var(--primary-color); background-color: #fdf6e3;
            padding: 1rem; border-radius: 50%; width: 60px; height: 60px;
            display: flex; justify-content: center; align-items: center;
        }
        .metric-card .metric-value { font-size: 1.8rem; font-weight: 700; color: var(--secondary-color); line-height: 1.2; }
        .chart-card { min-height: 350px; display: flex; flex-direction: column; }
        .chart-card canvas { flex-grow: 1; }
        @media (min-width: 600px) { .financial-card.metric-card { grid-column: span 6; } }
        @media (min-width: 992px) {
            .financial-card.metric-card { grid-column: span 3; }
            .financial-card.chart-card { grid-column: span 6; }
            .financial-card.bi-card { grid-column: span 12; }
        }

        .settings-card, .dashboard-card {
            background-color: var(--surface-color);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .settings-card h3, .dashboard-card h3 { margin-bottom: 1rem; color: var(--secondary-color); }
        .settings-card input, .settings-card select { width: 100%; margin-bottom: 1rem; }
        .settings-card button { width: 100%; margin-top: 0.5rem; }
        .settings-card hr { border: 0; border-top: 1px solid #eee; margin: 1rem 0; }

        /* ===== ESTILOS PARA FUNIL ARRASTÁVEL ===== */
        #funnel-editor .stage-item, #portfolio-list .portfolio-item, #amenities-list .amenity-list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.5rem; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 0.5rem;
            user-select: none;
            background-color: var(--surface-color);
        }
        #funnel-editor .stage-item, #portfolio-list .portfolio-item { cursor: move; }

        #funnel-editor .stage-item.dragging, #portfolio-list .portfolio-item.dragging { opacity: 0.5; background-color: #eaf2f8; }
        #funnel-editor input { margin: 0 0.5rem; flex-grow: 1; }
        #funnel-editor .stage-item button, #amenities-list .amenity-list-item button { background: none; border: none; color: var(--danger-color); cursor: pointer; }
        .drag-over-indicator { height: 2px; background: var(--accent-color); margin: 4px 0; border-radius: 1px; }

        /* ===== MODAIS ===== */
        .modal-container, .alert-modal-container {
            display: none; position: fixed; z-index: 2000;
            left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.6);
            justify-content: center; align-items: center;
        }
        .modal-container.active, .alert-modal-container.active { display: flex; }
        .modal-content, .alert-modal-content {
            background-color: #fefefe; margin: auto; padding: 2rem;
            border-radius: 10px; width: 90%;
            position: relative; animation: slideDown 0.5s;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-content { max-width: 800px; }
        .alert-modal-content { max-width: 500px; }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header, .alert-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h2, .alert-modal-header h2 { margin-bottom: 0; border: none; }
        .modal-close-btn, .alert-modal-close-btn { font-size: 2rem; font-weight: bold; cursor: pointer; background: none; border: none; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; }
        .modal-footer { margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem; }
        .alert-modal-body p { margin-bottom: 1rem; line-height: 1.6; }
        .alert-modal-body i { color: var(--warning-color); margin-right: 10px; }

        /* Estilos para cards de BI e Fichas de Visualização */
        .metric-value { font-size: 2rem; font-weight: 700; color: var(--primary-color); }
        .metric-label { font-size: 1rem; opacity: 0.8; }
        .bi-insight { margin-top: 1rem; font-size: 0.9rem; }
        .bi-insight strong { color: var(--secondary-color); }
        .record-details h3, .report-section h3 { color: var(--secondary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; margin-top: 20px; font-size: 1.2rem; }
        .record-details p { line-height: 1.8; margin-bottom: 0.5rem; }
        .record-details strong { color: #333; }
        .record-details a { color: var(--accent-color); font-size: 1.5rem; text-decoration: none; }
        .record-details .main-image { max-width: 100%; border-radius: 8px; margin-bottom: 1rem; }
        .record-details .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; background: #000; margin-top: 1rem; border-radius: 8px;}
        .record-details .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        
        /* Análise Financeira & Relatório de Funil */
        .analysis-result { background-color: #f8f9fa; border-radius: 8px; padding: 1rem; margin-top: 1rem; }
        .analysis-result h4 { color: var(--secondary-color); }
        .analysis-result p { margin: 0.5rem 0; }
        .analysis-result .highlight-success { color: var(--success-color); font-weight: 700; font-size: 1.2rem; }
        .analysis-result .highlight-danger { color: var(--danger-color); font-weight: 700; font-size: 1.2rem; }
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .report-card { background: #f8f9fa; padding: 1rem; border-radius: 5px; text-align: center; }
        .report-card .value { font-size: 1.5rem; font-weight: 700; color: var(--secondary-color); }
        .report-card .label { font-size: 0.9rem; }
        .report-section ul { list-style-position: inside; padding-left: 10px; }

        /* ===== INÍCIO: ESTILOS DA AGENDA-CALENDÁRIO ===== */
        #calendar-container {
            background-color: var(--surface-color);
            padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        #calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        #calendar-header button { background: none; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; padding: 0.5rem 1rem; }
        #month-year { font-size: 1.5rem; font-weight: 600; color: var(--secondary-color); }
        #calendar-grid, #weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; }
        #weekdays div { font-weight: bold; padding: 0.5rem 0; color: var(--secondary-color); }
        .calendar-day {
            border: 1px solid #eee; min-height: 120px; padding: 5px;
            display: flex; flex-direction: column; cursor: pointer; transition: background-color: 0.3s;
        }
        .calendar-day:hover { background-color: #f9f9f9; }
        .day-number { font-weight: bold; align-self: flex-start; }
        .calendar-day.other-month .day-number { opacity: 0.4; }
        .calendar-day.today .day-number {
            background-color: var(--primary-color); color: var(--secondary-color);
            border-radius: 50%; width: 28px; height: 28px;
            display: flex; justify-content: center; align-items: center;
        }
        .events-container { margin-top: 5px; flex-grow: 1; overflow-y: auto; max-height: 85px; }
        .event-pill {
    font-size: 0.75rem;
    padding: 3px 5px;
    margin-bottom: 3px;
    border-radius: 3px;
    background-color: var(--secondary-color);
    color: white;
    white-space: normal;     /* Permite a quebra de linha */
    overflow: visible;       /* Garante que o conteúdo não seja cortado */
    text-overflow: clip;     /* Remove o "..." */
    word-break: break-word;  /* Força a quebra de palavras longas */
}
        .event-pill i { margin-right: 4px; }
        .event-pill.event-pill-income { background-color: var(--success-color); }
        .event-pill.event-pill-expense { background-color: var(--danger-color); }
        .event-pill.completed { background-color: #6c757d; text-decoration: line-through; }
        .event-pill.overdue { background-color: var(--warning-color); }
        .day-events-list .event-item {
            background-color: #fff; border-left: 5px solid var(--secondary-color);
            padding: 1rem; margin-bottom: 1rem; border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .day-events-list .event-item.overdue { border-left-color: var(--danger-color); }
        .day-events-list .event-item.completed { text-decoration: line-through; opacity: 0.6; border-left-color: var(--success-color); }
        .day-events-list .birthday-item { border-left-color: #FFC107; }
        /* ===== FIM: ESTILOS DA AGENDA-CALENDÁRIO ===== */
        
        /* ===== INÍCIO: ESTILOS PARA DOCUMENTOS PDF ===== */
        #pdf-generator {
            position: absolute; left: -9999px; top: -9999px;
            width: 210mm;
            background: white;
            color: #333;
        }
        .pdf-document-container {
            font-family: 'Roboto', sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            padding: 15mm;
        }
        .pdf-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 2px solid #D4AF37;
            padding-bottom: 8mm;
            margin-bottom: 10mm;
        }
        .pdf-header-logo {
            max-width: 50mm;
            max-height: 25mm;
            object-fit: contain;
        }
        .pdf-header-info {
            text-align: right;
            font-size: 9pt;
        }
        .pdf-header-info h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 14pt;
            color: #2C3E50;
            margin: 0 0 5px 0;
        }
        .pdf-content h1, .pdf-content h2, .pdf-content h3 {
            font-family: 'Montserrat', sans-serif;
            color: #2C3E50;
            margin-top: 8mm;
            margin-bottom: 5mm;
            padding-bottom: 2mm;
            border-bottom: 1px solid #eee;
        }
        .pdf-content h1 { font-size: 16pt; text-align: center; }
        .pdf-content h2 { font-size: 13pt; }
        .pdf-content h3 { font-size: 12pt; margin-top: 6mm; margin-bottom: 3mm; border-bottom: none; }
        .pdf-content p { text-align: justify; margin-bottom: 4mm; }
        .pdf-signatures { margin-top: 20mm; }
        .pdf-signature-line {
            margin-top: 20mm;
            border-top: 1px solid #555;
            width: 70%;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
            padding-top: 2mm;
            font-size: 10pt;
        }
        .pdf-centered-text { text-align: center; }
        .receipt-value-box {
            background-color: #f4f6f9;
            border: 1px solid #ddd;
            padding: 10mm;
            margin: 8mm 0;
            text-align: center;
        }
        .receipt-value-box .value {
            font-size: 18pt;
            font-weight: 700;
            color: #2C3E50;
        }
        .receipt-value-box .value-in-words {
            font-size: 10pt;
            margin-top: 3mm;
            font-style: italic;
        }
         /* ===== FIM: NOVOS ESTILOS PARA DOCUMENTOS PDF ===== */

        /* ===== INÍCIO: NOVO TEMPLATE DE PORTFÓLIO ===== */
        .portfolio-page-v2 {
            width: 210mm;
            height: 297mm;
            padding: 12mm;
            background-color: white;
            color: var(--text-color);
            font-family: 'Montserrat', sans-serif;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }
        .portfolio-v2-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-bottom: 8mm;
            border-bottom: 2px solid var(--primary-color);
        }
        .portfolio-v2-broker-info { text-align: left; }
        .portfolio-v2-broker-info h1 {
            font-size: 14pt;
            color: var(--secondary-color);
            margin: 0;
            font-weight: 700;
        }
        .portfolio-v2-broker-info p {
            font-size: 9pt;
            margin: 2px 0 0 0;
            color: var(--text-color);
        }
        .portfolio-v2-logo {
            max-height: 15mm;
            max-width: 40mm;
            object-fit: contain;
        }
        .portfolio-v2-title {
            text-align: center;
            margin: 8mm 0;
        }
        .portfolio-v2-title h2 {
            font-size: 22pt;
            color: var(--secondary-color);
            margin: 0;
            font-weight: 700;
        }
        .portfolio-v2-title p {
            font-size: 11pt;
            margin-top: 2mm;
        }
        .portfolio-v2-image-gallery {
            display: grid;
            grid-template-columns: 2fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 4mm;
            height: 85mm;
            margin-bottom: 8mm;
        }
        .portfolio-v2-main-image {
            grid-column: 1 / 2;
            grid-row: 1 / 3;
            background-size: cover;
            background-position: center;
            border-radius: 4px;
        }
        .portfolio-v2-secondary-image-1, .portfolio-v2-secondary-image-2 {
            background-size: cover;
            background-position: center;
            border-radius: 4px;
        }
        .portfolio-v2-content-area {
            display: flex;
            gap: 8mm;
            flex-grow: 1;
        }
        .portfolio-v2-details {
            width: 55%;
        }
        .portfolio-v2-amenities {
            width: 45%;
        }
        .portfolio-v2-details h3, .portfolio-v2-amenities h3 {
            font-size: 12pt;
            color: var(--secondary-color);
            border-bottom: 1px solid #eee;
            padding-bottom: 2mm;
            margin-bottom: 4mm;
        }
        .portfolio-v2-description {
            font-size: 9.5pt;
            line-height: 1.6;
            text-align: justify;
        }
        .portfolio-v2-key-info {
            margin-top: 5mm;
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 4mm;
            font-size: 10pt;
        }
        .portfolio-v2-key-info p { margin: 0 0 2mm 0; }
        .portfolio-v2-amenities-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3mm 5mm;
            font-size: 9.5pt;
        }
        .portfolio-v2-amenity-item {
            display: flex;
            align-items: center;
            gap: 3mm;
        }
        .portfolio-v2-amenity-item i {
            color: var(--primary-color);
            width: 18px;
            text-align: center;
        }
        .portfolio-v2-footer {
            margin-top: auto;
            padding-top: 5mm;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            font-size: 8pt;
        }
        .portfolio-v2-motivational-text {
            font-style: italic;
            color: #555;
            width: 80%;
        }
        .portfolio-v2-page-number {
            color: #777;
        }
        /* ===== FIM: NOVO TEMPLATE DE PORTFÓLIO ===== */

        /* Galeria de Imagens */
        #image-gallery-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 3000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        #image-gallery-modal.active { display: flex; }
        #gallery-image-container { position: relative; width: 90%; height: 80%; }
        #gallery-image-container img { width: 100%; height: 100%; object-fit: contain; }
        .gallery-nav {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(0,0,0,0.5); color: white; border: none;
            font-size: 2.5rem; cursor: pointer; padding: 0 1rem;
        }
        #gallery-prev { left: 10px; }
        #gallery-next { right: 10px; }
        .gallery-tool {
            position: absolute; top: 15px;
            background: rgba(0,0,0,0.5); color: white; border: none;
            font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 5px;
        }
        #gallery-close { right: 15px; }
        #gallery-fullscreen { right: 70px; }
        #gallery-counter { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); color: white; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px;}

        /* Thumbnails de upload */
        #prop-image-previews, #note-image-previews { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .img-preview-container { position: relative; }
        .img-preview-container img { width: 100px; height: 100px; object-fit: cover; border-radius: 5px; }
        .remove-img-btn {
            position: absolute; top: -5px; right: -5px;
            background: var(--danger-color); color: white;
            border: none; border-radius: 50%;
            width: 20px; height: 20px; font-size: 12px;
            cursor: pointer; display: flex; justify-content: center; align-items: center;
        }
        .main-image-selector {
            position: absolute; bottom: 5px; left: 5px;
            color: #ccc; cursor: pointer; font-size: 1.2rem;
            text-shadow: 0 0 3px black; transition: color 0.2s;
        }
        .main-image-selector:hover { color: #e0e0e0; }
        .main-image-selector.active { color: var(--primary-color); }

        /* Gráfico do Funil */
        #funnel-chart-container {
            background-color: var(--surface-color);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-top: 2rem;
        }
        #funnel-chart {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 300px;
            border-left: 2px solid #ccc;
            border-bottom: 2px solid #ccc;
            padding: 10px 0;
        }
        .funnel-bar-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 15%;
            height: 100%;
            justify-content: flex-end;
        }
        .funnel-bar {
            width: 80%;
            border-radius: 5px 5px 0 0;
            transition: height 0.5s ease-out;
            position: relative;
            display: flex;
            justify-content: center;
        }
        .funnel-bar-label {
            position: absolute;
            top: -25px;
            font-weight: bold;
            color: var(--secondary-color);
        }
        .funnel-stage-name {
            margin-top: 10px;
            font-size: 0.9rem;
            text-align: center;
        }

        /* ===== NOVOS ESTILOS PARA DIFERENCIAIS ===== */
        .amenities-container {
             background-color: #f8f9fa;
             padding: 1rem;
             border-radius: 5px;
        }
        .amenities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 10px;
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 1rem; /* Espaço para o campo de adicionar */
        }
        .amenity-item {
            display: flex;
            align-items: center;
        }
        .amenity-item input[type="checkbox"] {
            margin-right: 10px;
        }
        .amenity-item label {
            font-weight: normal;
            font-size: 0.9rem;
        }
        .add-amenity-toolbar {
            display: flex;
            gap: 10px;
            margin-top: 1rem;
            border-top: 1px solid #ddd;
            padding-top: 1rem;
        }
         .add-amenity-toolbar input, .add-amenity-toolbar textarea { flex-grow: 1; }
         .add-amenity-toolbar button { flex-shrink: 0; }

        .amenities-display-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .amenity-display-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            font-size: 0.95rem;
        }
        .amenity-display-item i {
            color: var(--primary-color);
            width: 20px;
            text-align: center;
        }

        /* Estilos para campos de formulário ocultáveis */
        .hidden-field {
            display: none;
        }
        
        /* ===== NOVOS ESTILOS PARA RELATÓRIO DE PLANTÃO ===== */
        .attended-client-item {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr auto;
            gap: 1rem;
            align-items: center;
            padding: 1rem;
            border: 1px solid #eee;
            border-radius: 5px;
            margin-bottom: 0.5rem;
            background-color: #fdfdfd;
        }
        .attended-client-item .form-group {
            margin-bottom: 0;
        }
        .attended-client-item .form-group label {
            display: none; /* O placeholder já informa */
        }
        .attended-client-item button {
            align-self: center; /* Centraliza o botão verticalmente */
            margin-top: 0; /* Remove margem superior se houver */
        }
        #attended-clients-list {
            margin-bottom: 1rem;
        }
        .pdf-duty-report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8mm;
        }
        .pdf-duty-report-table th, .pdf-duty-report-table td {
            border: 1px solid #ddd;
            padding: 3mm;
            text-align: left;
            font-size: 10pt;
        }
        .pdf-duty-report-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        /* ===== NOVOS ESTILOS PARA Informes e Notas ===== */
        .info-card {
            background-color: var(--surface-color);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }
        .info-card-header {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }
        .info-card-thumb {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 5px;
            flex-shrink: 0;
        }
        .info-card-title-section h3 {
            color: var(--secondary-color);
            margin-bottom: 0.8rem;
        }
        .info-card-content {
            flex-grow: 1;
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text-color);
            margin-top: 1rem;
            max-height: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
            mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
        }
        .info-card-footer {
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        .info-card-footer button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: var(--secondary-color);
        }
        .info-card-footer button:hover {
            color: var(--primary-color);
        }
        .view-note-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 1rem;
        }
        .view-note-gallery img {
            width: 100%;
            height: auto;
            border-radius: 5px;
            object-fit: cover;
            cursor: pointer;
        }

        /* ===== NOVOS ESTILOS PARA DASHBOARD E CLIENTES ===== */
        .dashboard-card ul { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; }
        .dashboard-card li { margin-bottom: 0.8rem; padding-bottom: 0.8rem; border-bottom: 1px solid #eee; }
        .dashboard-card li:last-child { border-bottom: none; }
        .dashboard-event-item, .financial-alert-item { cursor: pointer; transition: color 0.2s; }
        .dashboard-event-item:hover, .financial-alert-item:hover { color: var(--primary-color); }
        .financial-alert-item.overdue { color: var(--danger-color); font-weight: bold; }
        .financial-alert-item .alert-details { font-size: 0.8rem; opacity: 0.8; display: block; }
        .status-realizado { font-weight: bold; color: var(--success-color); font-size: 0.8em; }
        #quick-actions-toast {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            background-color: var(--secondary-color); color: white;
            padding: 10px 20px; border-radius: 5px;
            z-index: 9999; display: none;
            animation: fadeInOut 3s forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; } 5% { opacity: 1; }
            95% { opacity: 1; } 100% { opacity: 0; }
        }
        .payment-status-section {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #eee;
        }

        /* ===== INÍCIO: ESTILOS DE IMPRESSÃO E QR CODE ===== */
        .qr-code-for-print {
            display: none; /* Oculto por padrão na tela */
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .print-area, .print-area * {
                visibility: visible;
            }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .printable-document {
                font-family: 'Roboto', sans-serif;
                font-size: 11pt;
                line-height: 1.5;
                padding: 15mm;
                color: #000;
            }
            .printable-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                border-bottom: 2px solid #D4AF37;
                padding-bottom: 8mm;
                margin-bottom: 10mm;
            }
            .printable-header-logo {
                max-width: 50mm;
                max-height: 25mm;
                object-fit: contain;
            }
            .printable-header-info h1 {
                font-family: 'Montserrat', sans-serif;
                font-size: 14pt;
                color: #2C3E50;
                margin: 0 0 5px 0;
            }
            .printable-header-info p {
                margin: 0;
                font-size: 9pt;
            }
            .printable-document h1, .printable-document h2, .printable-document h3 {
                font-family: 'Montserrat', sans-serif;
                color: #2C3E50;
                margin-top: 8mm;
                margin-bottom: 5mm;
                padding-bottom: 2mm;
                border-bottom: 1px solid #eee;
                page-break-after: avoid;
            }
            .printable-document .record-details {
                border: none;
                box-shadow: none;
                padding: 0;
            }
            .printable-document .record-details .main-image {
                max-width: 80%;
                display: block;
                margin-left: auto;
                margin-right: auto;
            }
            .printable-document .toolbar, .printable-document .modal-footer {
                display: none !important;
            }
            .printable-document .analysis-result {
                background-color: #f8f9fa !important;
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }
            .printable-document .report-grid {
                display: flex;
                justify-content: space-around;
            }
            .printable-document .report-card {
                border: 1px solid #ccc;
            }
            .printable-document a {
                text-decoration: none;
                color: #000;
            }
            
            /* REGRAS DO QR CODE PARA IMPRESSÃO */
            .link-for-screen {
                display: none; /* Oculta o link de texto na impressão */
            }
            .qr-code-for-print {
                display: block !important; /* Exibe a seção do QR code na impressão */
                margin-top: 15px;
                page-break-inside: avoid;
            }
            #property-qr-code-container img { /* O QR Code é gerado como uma imagem */
                display: block !important;
                visibility: visible !important;
                margin: 5px 0 0 0;
            }
            /* Remove a regra genérica de '::after' para links dentro da área de impressão */
            .printable-document a::after {
                content: ""; 
            }
        }
        /* ===== FIM: ESTILOS DE IMPRESSÃO ===== */

    </style>
</head>
<body>

    <header>
        <div class="logo-container">
            <img id="header-logo" src="https://via.placeholder.com/150x50.png?text=Sua+Logo" alt="Logo">
            <div class="broker-info">
                <h1 id="header-broker-name">Nome do Corretor</h1>
                <p id="header-broker-creci">CRECI: 00000</p>
            </div>
        </div>
        <nav>
            <button class="nav-btn active" data-panel="dashboard"><i class="fas fa-tachometer-alt"></i></button>
            <button class="nav-btn" data-panel="clients"><i class="fas fa-users"></i> Clientes</button>
            <button class="nav-btn" data-panel="properties"><i class="fas fa-building"></i> Imóveis</button>
            <button class="nav-btn" data-panel="agenda"><i class="fas fa-calendar-alt"></i> Agenda</button>
            <button class="nav-btn" data-panel="duty-reports"><i class="fas fa-clipboard-list"></i> Plantões</button>
            <button class="nav-btn" data-panel="informacoes"><i class="fas fa-book-open"></i> Notas</button>
            <button class="nav-btn" data-panel="documents"><i class="fas fa-file-contract"></i> Docs</button>
            <button class="nav-btn" data-panel="financial"><i class="fas fa-chart-line"></i> Fin</button>
            <button class="nav-btn" data-panel="links"><i class="fas fa-link"></i> </button>
            <button class="nav-btn" data-panel="settings"><i class="fas fa-cog"></i> </button>
            <a href="https://alexpeixoto85.github.io/relat-riopro/" target="_blank" class="nav-btn">
    <i class="fas fa-file-alt"></i>
</a>
        </nav>
        <div class="header-tools">
    <a href="https://alexpeixoto85.github.io/finan-aspropessoal/" target="_blank" class="calculator-link" title="Acessar Sistema Financeiro">
        <i class="fas fa-dollar-sign"></i>
    </a>
    <a href="https://alexpeixoto85.github.io/planoprofinal/" target="_blank" class="calculator-link" title="Calculadora Financeira">
        <i class="fas fa-calculator"></i>
    </a>
</div>
    </header>

    <main>
        <div id="panel-dashboard" class="panel active">
            <h2>Dashboard</h2>
            <div id="dashboard-content" class="dashboard-grid"></div>
            <div id="funnel-chart-container">
                 <h3>Funil</h3>
                 <div id="funnel-chart"></div>
            </div>
        </div>

        <div id="panel-clients" class="panel">
            <h2>Gestão de Clientes</h2>
            <div class="toolbar">
                <input type="text" id="client-search" placeholder="Buscar por nome, contato ou CPF...">
                <select id="client-source-filter" style="flex-grow: 0; min-width: 180px;">
                    <option value="all">Todas as Origens</option>
                    <option value="imobiliária">Imobiliária</option>
                    <option value="plantão">Plantão</option>
                    <option value="construtora">Construtora</option>
                    <option value="patrocinado">Patrocinado</option>
                    <option value="ação de rua">Ação de Rua</option>
                    <option value="indicação">Indicação</option>
                </select>
                <button id="add-client-btn" class="btn-primary"><i class="fas fa-plus"></i> Novo Cliente</button>
                <button id="mass-whatsapp-btn" class="btn-secondary"><i class="fab fa-whatsapp"></i> Envio em Massa</button>
                <button id="export-clients-excel" class="btn-success"><i class="fas fa-file-excel"></i> Exportar Vista Atual</button>
            </div>
            <div id="funnel-filter-buttons" class="funnel-filters"></div>
            <div class="table-container">
                <table id="clients-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-clients"></th>
                            <th>Nome</th>
                            <th>Contato</th>
                            <th>Etapa do Funil</th>
                            <th>Último Contato</th>
                            <th>Valor do Imóvel</th>
                            <th>Comissão</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="panel-properties" class="panel">
            <h2>Gestão de Imóveis</h2>
            <div class="toolbar">
                <input type="text" id="property-search" placeholder="Buscar por nome ou localização...">
                <button id="add-property-btn" class="btn-primary"><i class="fas fa-plus"></i> Novo Imóvel</button>
                <button id="generate-portfolio-btn" class="btn-secondary"><i class="fas fa-book-open"></i> Gerar Portfólio</button>
                <button id="export-properties-excel" class="btn-success"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
            </div>
            <div class="table-container">
                <table id="properties-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-properties"></th>
                            <th>Nome</th>
                            <th>Valor de Tabela</th>
                            <th>Valor de Avaliação</th>
                            <th>Localização</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div id="panel-agenda" class="panel">
            <div class="toolbar">
                 <h2>Agenda de Compromissos</h2>
                 <button id="add-event-btn" class="btn-primary" style="margin-left: auto;"><i class="fas fa-plus"></i> Novo Compromisso</button>
            </div>
            <div id="calendar-container">
                <div id="calendar-header">
                    <button id="prev-month-btn"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="month-year"></h3>
                    <button id="next-month-btn"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div id="weekdays"></div>
                <div id="calendar-grid"></div>
            </div>
        </div>

        <div id="panel-duty-reports" class="panel">
            <h2>Relatórios de Plantão</h2>
            <div class="toolbar">
                <button id="add-duty-report-btn" class="btn-primary"><i class="fas fa-plus"></i> Novo Relatório de Plantão</button>
            </div>
            <div class="table-container">
                <table id="duty-reports-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Local</th>
                            <th>Clientes Atendidos</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div id="panel-informacoes" class="panel">
            <h2>Informes e Notas</h2>
            <div class="toolbar">
                <input type="text" id="info-search" placeholder="Buscar por título ou conteúdo...">
                <button id="add-info-btn" class="btn-primary"><i class="fas fa-plus"></i> Nova Informação</button>
            </div>
            <div id="info-cards-container" class="dashboard-grid">
                </div>
        </div>

        <div id="panel-documents" class="panel">
            <h2>Gestão de Documentos</h2>
            <div class="toolbar">
                <button id="add-contract-btn" class="btn-primary"><i class="fas fa-plus"></i> Gerar Contrato</button>
                <button id="add-receipt-btn" class="btn-success"><i class="fas fa-receipt"></i> Gerar Recibo</button>
            </div>
            <div class="table-container">
                <table id="documents-table">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Cliente(s)</th>
                            <th>Imóvel</th>
                            <th>Valor</th>
                            <th>Data</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div id="panel-financial" class="panel">
            <div class="financial-panel-header">
                <h2>Financeiro e Business Intelligence</h2>
                <div class="header-buttons">
                    <button id="generate-financial-report-btn" class="btn-secondary"><i class="fas fa-file-invoice-dollar"></i> Gerar Relatório</button>
                    <button id="add-income-btn" class="btn-success"><i class="fas fa-plus"></i> Nova Receita</button>
                    <button id="add-expense-btn" class="btn-danger"><i class="fas fa-minus"></i> Nova Despesa</button>
                </div>
            </div>
            <div id="financial-bi-content" class="financial-grid-container"></div>
            <h3>Lançamentos Financeiros</h3>
            <div class="table-container">
                <table id="financial-records-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Descrição</th>
                            <th>Categoria</th>
                            <th>Tipo</th>
                            <th>Valor</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div id="panel-links" class="panel">
            <h2></h2>
            <div class="toolbar">
                <button id="add-link-btn" class="btn-primary"><i class="fas fa-plus"></i> Novo Link</button>
            </div>
            <div class="table-container">
                <table id="links-table">
                    <thead>
                        <tr>
                            <th>Título</th>
                            <th>URL</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="panel-settings" class="panel">
            <h2></h2>
            <div class="settings-grid">
                <div class="settings-card">
                    <h3>Dados do Corretor</h3>
                    <input type="text" id="setting-broker-name" placeholder="Seu Nome Completo">
                    <input type="text" id="setting-broker-creci" placeholder="Seu CRECI">
                    <input type="text" id="setting-broker-phone" placeholder="Seu Telefone (com 55 e DDD)">
                    <label for="setting-logo-upload">Logo Marca:</label>
                    <input type="file" id="setting-logo-upload" accept="image/*">
                    <button id="save-broker-info" class="btn-primary">Salvar Dados</button>
                </div>
                <div class="settings-card">
                    <h3>Metas e Padrões</h3>
                    <label>Meta Mensal de Leads:</label>
                    <input type="number" id="setting-leads-goal" placeholder="Ex: 50">
                    <label>Meta de Faturamento Mensal (R$):</label>
                    <input type="number" id="setting-revenue-goal" placeholder="Ex: 50000">
                    <label>Comissão Padrão (%):</label>
                    <input type="number" id="setting-default-commission" placeholder="Ex: 5">
                     <button id="save-goals" class="btn-primary">Salvar Metas</button>
                </div>
                <div class="settings-card">
                    <h3>Gestão do Funil de Vendas (Arraste para reordenar)</h3>
                    <div id="funnel-editor"></div>
                    <div class="toolbar">
                        <input type="text" id="new-stage-name" placeholder="Nome da etapa">
                        <input type="number" id="new-stage-prob" placeholder="Prob. de Venda (%)">
                    </div>
                    <button id="add-stage-btn" class="btn-secondary">Adicionar Etapa</button>
                </div>
                 <div class="settings-card">
                    <h3>Gestão de Diferenciais</h3>
                    <div id="amenities-list" style="max-height: 250px; overflow-y: auto; margin-bottom: 1rem;"></div>
                    </div>
                <div class="settings-card">
                    <h3>Gerenciamento de Dados</h3>
                    <label>Importar Planilha (Clientes ou Imóveis):</label>
                    <div class="toolbar">
                        <input type="file" id="import-excel" accept=".xlsx">
                        <select id="import-type">
                            <option value="clients">Clientes</option>
                            <option value="properties">Imóveis</option>
                        </select>
                    </div>
                     <button id="import-btn" class="btn-secondary">Importar Planilha</button>
                    <button id="download-template-btn" class="btn-link">Baixar Modelo de Planilha</button>
                    <hr>
                    <button id="export-backup-btn" class="btn-secondary">Exportar Backup Completo (JSON)</button>
                    <label>Importar Backup (JSON):</label>
                    <input type="file" id="import-backup" accept=".json">
                    <button id="import-backup-btn" class="btn-secondary">Importar Backup</button>
                    <hr>
                    <button id="delete-duplicates-btn" class="btn-danger">Excluir Clientes Duplicados</button>
                    <button id="clear-system-btn" class="btn-danger">Limpar Todo o Sistema</button>
                </div>
            </div>
        </div>
    </main>
    
    <div id="modal-container" class="modal-container">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title"></h2>
                <button id="modal-close-btn" class="modal-close-btn">&times;</button>
            </div>
            <div id="modal-body"></div>
            <div class="modal-footer">
                <button id="modal-cancel-btn" class="btn-secondary">Cancelar</button>
                <button id="modal-save-btn" class="btn-primary">Salvar</button>
            </div>
        </div>
    </div>

    <div id="alert-modal-container" class="alert-modal-container">
        <div class="alert-modal-content">
            <div class="alert-modal-header">
                <h2 id="alert-modal-title"></h2>
                <button id="alert-modal-close-btn" class="alert-modal-close-btn">&times;</button>
            </div>
            <div id="alert-modal-body" class="alert-modal-body"></div>
        </div>
    </div>
    
    <div id="pdf-generator"></div>

    <div id="print-area" class="print-area"></div>

    <div id="quick-actions-toast"></div>
    
    <div id="image-gallery-modal">
        <div id="gallery-image-container">
            <img id="gallery-current-image" src="" alt="Imagem do Imóvel">
            <button id="gallery-prev" class="gallery-nav"><i class="fas fa-chevron-left"></i></button>
            <button id="gallery-next" class="gallery-nav"><i class="fas fa-chevron-right"></i></button>
            <button id="gallery-close" class="gallery-tool" title="Fechar"><i class="fas fa-times"></i></button>
            <button id="gallery-fullscreen" class="gallery-tool" title="Tela Cheia"><i class="fas fa-expand"></i></button>
            <div id="gallery-counter"></div>
        </div>
    </div>

    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script>
    // =================================================================================
    // SCRIPT COMPLETO DO SISTEMA CRM (ARQUIVO ÚNICO)
    // =================================================================================
    document.addEventListener('DOMContentLoaded', () => {
	// =================================================================================
// BANCO DE MENSAGENS E EMOJIS PARA WHATSAPP
// =================================================================================
const messageTemplates = [
    "Olá, [nome]! Tenho ótimas novidades sobre imóveis que podem te interessar. Quando podemos conversar?",
    "Oi, [nome], tudo bem? Passando para saber se ainda está buscando o imóvel dos seus sonhos. Tenho algumas opções excelentes!",
    "Que tal encontrar seu novo lar, [nome]? Tenho umas oportunidades imperdíveis que acabaram de chegar para mim.",
    "Olá, [nome]! Como vai a busca pelo imóvel ideal? Gostaria de te apresentar algumas novidades que combinam com seu perfil.",
    "Oi, [nome]! Pensando em você, separei alguns imóveis incríveis. Acredito que um deles seja a sua cara!"
];

const emojis = [
    "🏡", "🏢", "🔑", "🏠", "🏘️", "🏙️", "✨", "⭐", "🚀"
];

// Função auxiliar para criar uma pausa (delay)
const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));
// =================================================================================

        // ==========================================
        // BANCO DE DADOS (INDEXEDDB COM DEXIE.JS)
        // ==========================================
        const dexieDb = new Dexie('CRMLuxoDatabase');
        dexieDb.version(1).stores({
            dataStore: 'id' // 'id' será a chave primária (usaremos um ID fixo: 1)
        });
    
        // ==========================================
        // ELEMENTOS DO DOM
        // ==========================================
        const modalContainer = document.getElementById('modal-container');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalFooter = document.querySelector('.modal-footer');

        const alertModalContainer = document.getElementById('alert-modal-container');
        const alertModalTitle = document.getElementById('alert-modal-title');
        const alertModalBody = document.getElementById('alert-modal-body');

        let currentEditingId = null; 
        let currentEntityType = ''; 
        let tempPropertyImages = [];
        let tempMainImageIndex = -1;
        let tempNoteImages = []; 
        let currentCalendarDate = new Date();
        let currentPaymentDateToConfirm = null;
    
        // ==========================================
        // ESTADO INICIAL E MANIPULAÇÃO DE DADOS
        // ==========================================
        let db = {};
    
        const defaultDb = {
            settings: {
                brokerName: 'Nome do Corretor',
                brokerCreci: 'CRECI: 00000',
                brokerPhone: '5582999998888',
                logoUrl: 'https://via.placeholder.com/150x50.png?text=Sua+Logo',
                goals: { leads: 50, revenue: 50000, },
                defaultCommission: 5,
            },
            funnelStages: [
                { id: 1, name: 'Lead', probability: 5 },
                { id: 2, name: 'Contato Realizado', probability: 20 },
                { id: 3, name: 'Visita Agendada', probability: 50 },
                { id: 4, name: 'Proposta Enviada', probability: 75 },
                { id: 5, name: 'Venda', probability: 100 },
            ],
            amenities: [
                { name: 'Piscina Adulto', icon: 'fas fa-swimmer' },
                { name: 'Piscina Infantil', icon: 'fas fa-child' },
                { name: 'Piscina com Raia', icon: 'fas fa-water' },
                { name: 'Piscina', icon: 'fas fa-swimming-pool' },
                { name: 'Playground', icon: 'fas fa-puzzle-piece' },
                { name: 'Salão de Festas', icon: 'fas fa-birthday-cake' },
                { name: 'Espaço Gourmet', icon: 'fas fa-utensils' },
                { name: 'Espaço Kids', icon: 'fas fa-shapes' },
                { name: 'Pet Place', icon: 'fas fa-paw' },
                { name: 'Bicicletário', icon: 'fas fa-bicycle' },
                { name: 'Academia', icon: 'fas fa-dumbbell' },
                { name: 'CFTV', icon: 'fas fa-video' },
                { name: 'Varanda Gourmet', icon: 'fas fa-cloud-meatball' },
                { name: 'Wi-fi nas áreas de lazer', icon: 'fas fa-wifi' }
            ],
            clients: [],
            properties: [],
            events: [],
            usefulLinks: [],
            contracts: [],
            financialRecords: [],
            performanceSnapshots: [],
            dutyReports: [],
            knowledgeBase: [],
        };
    
        const saveData = async () => {
            try {
                await dexieDb.dataStore.put({ id: 1, data: db });
            } catch (error)
                {
                console.error("Falha ao salvar os dados no IndexedDB:", error);
                alert("Ocorreu um erro crítico ao tentar salvar os dados. Suas alterações recentes podem não ter sido salvas.");
            }
        };

        const generatePaymentsArray = (record) => {
            const payments = [];
            const startDate = new Date(record.startDate + 'T00:00:00');
            const installments = record.recurrence === 'monthly' ? 1200 : (record.totalInstallments || 1); 

            for (let i = 0; i < installments; i++) {
                const paymentDate = new Date(startDate);
                paymentDate.setMonth(startDate.getMonth() + i);
                payments.push({
                    date: paymentDate.toISOString().slice(0, 10),
                    status: 'pending'
                });
            }
            return payments;
        };

        const loadData = async () => {
            const oldData = localStorage.getItem('crmImobiliarioData');
            if (oldData) {
                 // ... (código de migração do localStorage, sem alterações) ...
            } else {
                const storedData = await dexieDb.dataStore.get(1);
                if (storedData) {
                    console.log("Dados carregados do IndexedDB.");
                    db = { ...defaultDb, ...storedData.data };
                } else {
                    console.log("Nenhum dado encontrado. Inicializando com o padrão.");
                    db = JSON.parse(JSON.stringify(defaultDb));
                    await saveData();
                }
            }

            if (!db.financialRecords) db.financialRecords = [];
            if (!db.performanceSnapshots) db.performanceSnapshots = [];
            if (!db.amenities) db.amenities = defaultDb.amenities;
            if (!db.dutyReports) db.dutyReports = [];
            if (!db.knowledgeBase) db.knowledgeBase = [];
            
            db.knowledgeBase.forEach(note => {
                if (note.images === undefined) note.images = [];
                if (note.videos === undefined) note.videos = [];
            });
            db.clients.forEach(c => { if (c.lastContact === undefined) c.lastContact = null; });

            let needsSave = false;
            db.financialRecords.forEach(record => {
                if (!record.payments) {
                    console.log(`Migrando lançamento financeiro antigo: ${record.description}`);
                    record.payments = generatePaymentsArray(record);
                    needsSave = true;
                }
            });
            if (needsSave) {
                console.log("Salvando dados após migração da estrutura financeira.");
                await saveData();
            }
        };
    
        // ==========================================
        // FUNÇÕES UTILITÁRIAS
        // ==========================================
        const formatCurrency = (value) => Number(value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const formatDate = (dateString) => dateString ? new Date(dateString + 'T00:00:00').toLocaleDateString('pt-BR') : ''; // Correção de fuso
        const getAgeInMonths = (birthdateString) => {
            if (!birthdateString) return null;
            const birthDate = new Date(birthdateString + 'T00:00:00'); // Correção de fuso
            const today = new Date();
            if (isNaN(birthDate.getTime())) return null;
            return (today.getFullYear() - birthDate.getFullYear()) * 12 + (today.getMonth() - birthDate.getMonth());
        };
       
        const numberToWords = (n) => {
            if (n === null || n === undefined) return '';
            let num = n.toFixed(2).toString().split('.');
            let inteiros = parseInt(num[0]);
            let centavos = parseInt(num[1]);

            const a = ['','um','dois','três','quatro','cinco','seis','sete','oito','nove','dez','onze','doze','treze','catorze','quinze','dezesseis','dezessete','dezoito','dezenove'];
            const b = ['','','vinte','trinta','quarenta','cinquenta','sessenta','setenta','oitenta','noventa'];
            const c = ['','cem','duzentos','trezentos','quatrocentos','quinhentos','seiscentos','setecentos','oitocentos','novecentos'];
            
            const extenso = (number) => {
                if (isNaN(number) || number === 0) return '';
                if (number < 20) return a[number];
                if (number < 100) return b[Math.floor(number/10)] + (number % 10 !== 0 ? ' e ' + a[number % 10] : '');
                if (number < 1000) {
                    if (number === 100) return 'cem';
                    return c[Math.floor(number/100)] + (number % 100 !== 0 ? ' e ' + extenso(number % 100) : '');
                }
                if (number < 1000000) {
                    const mil = Math.floor(number / 1000);
                    return (mil === 1 ? 'mil' : extenso(mil) + ' mil') + (number % 1000 !== 0 ? ' ' + extenso(number % 1000) : '');
                }
                return 'valor muito alto'; // Limitação simples
            };

            let strInteiros = extenso(inteiros);
            let strCentavos = extenso(centavos);

            let resultado = '';
            if (inteiros > 0) {
                resultado += strInteiros + (inteiros === 1 ? ' real' : ' reais');
            }
            if (centavos > 0) {
                if (inteiros > 0) resultado += ' e ';
                resultado += strCentavos + (centavos === 1 ? ' centavo' : ' centavos');
            }
            if (resultado === '') return 'zero reais';

            return resultado.charAt(0).toUpperCase() + resultado.slice(1);
        };
// ==========================================
// NOVA FUNÇÃO: VERIFICAR CLIENTES ESTAGNADOS
// ==========================================
const getStaleClientsForArchiving = () => {
    const staleClients = [];
    // Pega o ID da primeira etapa do funil (Ex: 'Lead') para não sugerir arquivamento de leads novos
    const firstStageId = db.funnelStages[0]?.id; 

    db.clients.forEach(client => {
        // 1. Verifica se o cliente tem um histórico E se tem 3 ou mais contatos
        if (client.contactHistory && client.contactHistory.length >= 3) {

            // 2. Pega os dois últimos contatos registrados
            const lastContact = client.contactHistory[client.contactHistory.length - 1];
            const secondLastContact = client.contactHistory[client.contactHistory.length - 2];

            // 3. Verifica se a etapa do funil é a MESMA entre os dois últimos contatos
            //    E também impede que clientes na primeira etapa sejam arquivados
            if (lastContact.stageId === secondLastContact.stageId && client.stageId !== firstStageId) {
                staleClients.push(client);
            }
        }
    });
    return staleClients;
};


        // ==========================================
        // NAVEGAÇÃO E RENDERIZAÇÃO GERAL
        // ==========================================
        const navButtons = document.querySelectorAll('.nav-btn');
        const panels = document.querySelectorAll('.panel');
    
        const switchPanel = (panelId) => {
            panels.forEach(p => p.classList.remove('active'));
            document.getElementById(`panel-${panelId}`)?.classList.add('active');
            navButtons.forEach(b => b.classList.remove('active'));
            document.querySelector(`.nav-btn[data-panel="${panelId}"]`)?.classList.add('active');
            
            switch(panelId) {
                case 'dashboard': renderDashboard(); break;
                case 'clients': renderClientsTable(); renderFunnelFilters(); break;
                case 'properties': renderPropertiesTable(); break;
                case 'agenda': renderAgendaCalendar(); break;
                case 'duty-reports': renderDutyReportsTable(); break;
                case 'informacoes': renderKnowledgeBase(); break;
                case 'documents': renderDocumentsTable(); break;
                case 'financial': renderFinancialBI(); renderFinancialRecordsTable(); break;
                case 'links': renderLinksTable(); break;
                case 'settings': renderSettings(); break;
            }
        };
    
        navButtons.forEach(button => {
            button.addEventListener('click', () => switchPanel(button.dataset.panel));
        });
    
        const updateHeader = () => {
            document.getElementById('header-broker-name').textContent = db.settings.brokerName;
            document.getElementById('header-broker-creci').textContent = db.settings.brokerCreci;
            document.getElementById('header-logo').src = db.settings.logoUrl;
        };
    
        // ==========================================
        // MODAIS (GERAL, ALERTA)
        // ==========================================
        const openModal = (title, bodyHtml, entityType, id = null, showFooter = true) => {
            modalTitle.textContent = title;
            modalBody.innerHTML = bodyHtml;
            currentEditingId = id;
            currentEntityType = entityType;
            modalFooter.style.display = showFooter ? 'flex' : 'none';
            modalContainer.classList.add('active');
            
            if (entityType === 'property') {
                document.getElementById('prop-images')?.addEventListener('change', handleImageSelection);
                document.getElementById('prop-image-previews')?.addEventListener('click', handleImagePreviewActions);
            }
            if (entityType === 'knowledgeBase') {
                 document.getElementById('note-images')?.addEventListener('change', handleNoteImageSelection);
                 document.getElementById('note-image-previews')?.addEventListener('click', handleNoteImagePreviewActions);
            }
             if (entityType === 'dutyReport') {
                document.getElementById('add-attended-client-btn')?.addEventListener('click', addAttendedClientRow);
                document.getElementById('attended-clients-list')?.addEventListener('click', handleAttendedClientActions);
            }
            if (entityType === 'financialRecord' && document.getElementById('confirm-payment-btn')) {
                 document.getElementById('confirm-payment-btn').addEventListener('click', confirmPayment);
            }
            if (entityType === 'portfolio') {
                modalSaveBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Gerar Portfólio PDF';
            } else if (entityType === 'contract' || entityType === 'receipt') {
                modalSaveBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Gerar e Salvar';
            }
            else {
                modalSaveBtn.innerHTML = 'Salvar';
            }
        };
    
        const closeModal = () => {
            modalContainer.classList.remove('active');
            modalTitle.textContent = '';
            modalBody.innerHTML = '';
            currentEditingId = null;
            currentEntityType = '';
            tempPropertyImages = [];
            tempMainImageIndex = -1;
            tempNoteImages = [];
            currentPaymentDateToConfirm = null;
        };
    
        document.getElementById('modal-close-btn').addEventListener('click', closeModal);
        document.getElementById('modal-cancel-btn').addEventListener('click', closeModal);
        
        const openAlertModal = (title, message) => {
            alertModalTitle.textContent = title;
            alertModalBody.innerHTML = message;
            alertModalContainer.classList.add('active');
        };
        const closeAlertModal = () => alertModalContainer.classList.remove('active');
        document.getElementById('alert-modal-close-btn').addEventListener('click', closeAlertModal);

        // ==========================================
        // SISTEMA DE ALERTA DE INICIALIZAÇÃO
        // ==========================================
        const checkStartupAlerts = () => {
            const firstStageId = db.funnelStages[0]?.id;
            const uncontactedLeads = firstStageId ? db.clients.filter(c => c.stageId === firstStageId).length : 0;

            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const pendingTasks = db.events.filter(e => {
                if (e.completed || !e.date) return false;
                const eventDate = new Date(e.date + 'T00:00:00');
                return eventDate < today;
            }).length;

            let alertMessage = '';
            if (uncontactedLeads > 0) {
                alertMessage += `<p><i class="fas fa-user-clock"></i> Você tem <strong>${uncontactedLeads} lead(s)</strong> na primeira etapa do funil aguardando contato.</p>`;
            }
            if (pendingTasks > 0) {
                alertMessage += `<p><i class="fas fa-exclamation-triangle"></i> Você tem <strong>${pendingTasks} tarefa(s) pendente(s)</strong> na sua agenda.</p>`;
            }

            if (alertMessage) {
                openAlertModal('Lembretes Importantes', alertMessage);
            }
        };

        // ==========================================
        // GESTÃO DE CLIENTES
        // ==========================================
        const getClientFormHtml = (client = {}) => {
            const funnelOptions = db.funnelStages.map(stage => 
                `<option value="${stage.id}" ${client.stageId == stage.id ? 'selected' : ''}>${stage.name}</option>`
            ).join('');

            const propertyOptions = db.properties.map(prop =>
                `<option value="${prop.id}" ${client.propertyId == prop.id ? 'selected' : ''}>${prop.name} - ${formatCurrency(prop.listPrice)}</option>`
            ).join('');
            
            const leadSources = ["imobiliária", "plantão", "construtora", "patrocinado", "ação de rua", "indicação"];
            const sourceOptions = leadSources.map(source => 
                `<option value="${source}" ${client.leadSource === source ? 'selected' : ''}>${source.charAt(0).toUpperCase() + source.slice(1)}</option>`
            ).join('');
            
            return `
                <div class="form-grid">
                    <div class="form-group"><label for="client-name">Nome Completo</label><input type="text" id="client-name" value="${client.name || ''}"></div>
                    <div class="form-group"><label for="client-phone">Contato (WhatsApp)</label><input type="text" id="client-phone" value="${client.phone || ''}"></div>
                    <div class="form-group"><label for="client-email">E-mail</label><input type="email" id="client-email" value="${client.email || ''}"></div>
                    <div class="form-group"><label for="client-cpf">CPF</label><input type="text" id="client-cpf" value="${client.cpf || ''}"></div>
                    <div class="form-group"><label for="client-birthdate">Data de Nascimento</label><input type="date" id="client-birthdate" value="${client.birthdate || ''}"></div>
                    <div class="form-group"><label for="client-income">Renda (R$)</label><input type="number" id="client-income" value="${client.income || ''}"></div>
                    <div class="form-group"><label for="client-property-value">Valor do Imóvel Pretendido (R$)</label><input type="number" id="client-property-value" value="${client.propertyValue || ''}"></div>
                    <div class="form-group"><label for="client-commission">Comissão Personalizada (%)</label><input type="number" id="client-commission" placeholder="Padrão: ${db.settings.defaultCommission}%" value="${client.commission || ''}"></div>
                    <div class="form-group"><label for="client-stageId">Etapa do Funil</label><select id="client-stageId">${funnelOptions}</select></div>
                    <div class="form-group"><label for="client-lead-source">Origem do Lead</label><select id="client-lead-source"><option value="">Selecione...</option>${sourceOptions}</select></div>
                    <div class="form-group full-width"><label for="client-propertyId">Imóvel de Interesse</label><select id="client-propertyId"><option value="">Nenhum</option>${propertyOptions}</select></div>
                    <div class="form-group full-width"><label for="client-notes">Observações</label><textarea id="client-notes">${client.notes || ''}</textarea></div>
                </div>
            `;
        };
    
        document.getElementById('add-client-btn').addEventListener('click', () => {
            openModal('Cadastrar Novo Cliente', getClientFormHtml(), 'client');
        });
    
        const renderClientsTable = (filter = '', stageFilter = null, sourceFilter = null) => {
            const tbody = document.querySelector('#clients-table tbody');
            tbody.innerHTML = '';
            
            let filteredClients = db.clients.filter(c => 
                (c.name || '').toLowerCase().includes(filter.toLowerCase()) || 
                (c.phone || '').includes(filter) || 
                (c.cpf || '').includes(filter)
            );
            
            if (stageFilter) {
                filteredClients = filteredClients.filter(c => c.stageId == stageFilter);
            }

            if (sourceFilter) {
                filteredClients = filteredClients.filter(c => c.leadSource === sourceFilter);
            }
    
            if (filteredClients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">Nenhum cliente encontrado.</td></tr>'; return;
            }
    
            filteredClients.forEach(client => {
                const stage = db.funnelStages.find(s => s.id === client.stageId);
                const property = db.properties.find(p => p.id == client.propertyId);
                const propertyValue = property ? property.listPrice : client.propertyValue;
                const commission = client.commission || db.settings.defaultCommission;
                const commissionValue = (propertyValue * commission) / 100;
                
                tbody.innerHTML += `
                    <tr>
                        <td><input type="checkbox" class="client-checkbox" data-phone="${client.phone}"></td>
                        <td>${client.name}</td>
                        <td>${client.phone}</td>
                        <td>${stage ? stage.name : 'N/A'}</td>
                        <td>${client.lastContact ? formatDate(client.lastContact) : 'Nenhum'}</td>
                        <td>${formatCurrency(propertyValue)}</td>
                        <td>${formatCurrency(commissionValue)} (${commission}%)</td>
                        <td class="action-buttons">
                            <button title="Visualizar Ficha" data-action="view" data-id="${client.id}"><i class="fas fa-eye"></i></button>
                            <button title="Imprimir Ficha" data-action="print" data-id="${client.id}"><i class="fas fa-print"></i></button>
                            <button title="Análise de Financiamento" data-action="analyze" data-id="${client.id}"><i class="fas fa-search-dollar"></i></button>
                            <a href="https://wa.me/${(client.phone || '').replace(/\D/g, '')}" target="_blank" title="Contatar" data-action="contact" data-id="${client.id}"><i class="fab fa-whatsapp"></i></a>
                            <button title="Editar" data-action="edit" data-id="${client.id}"><i class="fas fa-edit"></i></button>
                            <button title="Excluir" data-action="delete" data-id="${client.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        };
        
        const triggerClientTableRender = () => {
            const searchValue = document.getElementById('client-search').value;
            const stageValue = document.querySelector('.funnel-filter-btn.active')?.dataset.stageId;
            const sourceValue = document.getElementById('client-source-filter').value;
            renderClientsTable(
                searchValue,
                stageValue === 'all' ? null : stageValue,
                sourceValue === 'all' ? null : sourceValue
            );
        };

        document.getElementById('client-search').addEventListener('input', triggerClientTableRender);
        document.getElementById('client-source-filter').addEventListener('change', triggerClientTableRender);
    
        document.querySelector('#clients-table tbody').addEventListener('click', e => {
            const button = e.target.closest('button, a');
            if (!button) return;
            const id = button.dataset.id;
            const action = button.dataset.action;
    
            if (action === 'edit') {
                const client = db.clients.find(c => c.id == id);
                openModal('Editar Cliente', getClientFormHtml(client), 'client', id);
            } else if (action === 'delete') {
                if (confirm(`Deseja realmente excluir o cliente?`)) {
                    db.clients = db.clients.filter(c => c.id != id);
                    saveData();
                    triggerClientTableRender();
                }
            } else if (action === 'print') {
                const client = db.clients.find(c => c.id == id);
                const clientHtml = getClientDetailsHtml(id);
                const title = `Ficha do Cliente: ${client.name}`;
                printContent(clientHtml, title);
            } else if (action === 'analyze') {
                handleFinancingAnalysis(id);
            } else if (action === 'view') {
                 const client = db.clients.find(c => c.id == id);
                 const clientHtml = getClientDetailsHtml(id);
                 const modalBodyHtml = `
                    <div class="record-details" data-client-id="${id}">${clientHtml}</div>
                    <div class="modal-footer" style="display:flex; justify-content: flex-end; margin-top: 1rem;">
                        <button class="btn-primary" id="print-modal-btn"><i class="fas fa-print"></i> Imprimir</button>
                    </div>`;
                 openModal(`Ficha de ${client.name}`, modalBodyHtml, 'view', null, false);
                 document.getElementById('print-modal-btn').addEventListener('click', () => {
                    printContent(clientHtml, `Ficha do Cliente: ${client.name}`);
                 });
            } else if (action === 'contact') {
    const client = db.clients.find(c => c.id == id);
    if (client) {
        // Atualiza a data do último contato (para exibição na tabela)
        client.lastContact = new Date().toISOString().slice(0, 10);

        // INÍCIO DA NOVA LÓGICA: Adiciona ao histórico de contatos
        if (!client.contactHistory) {
            client.contactHistory = []; // Cria o histórico se não existir
        }

        client.contactHistory.push({
            date: client.lastContact,
            stageId: client.stageId // Salva qual era a etapa do funil NESTE contato
        });
        // FIM DA NOVA LÓGICA

        saveData();
        triggerClientTableRender();
    }
}
        });
        
        const renderFunnelFilters = () => {
            const container = document.getElementById('funnel-filter-buttons');
            container.innerHTML = '<button class="funnel-filter-btn active" data-stage-id="all">Todos</button>';
            db.funnelStages.forEach(stage => {
                container.innerHTML += `<button class="funnel-filter-btn" data-stage-id="${stage.id}">${stage.name}</button>`;
            });
        };

        document.getElementById('funnel-filter-buttons').addEventListener('click', e => {
            if(e.target.tagName === 'BUTTON'){
                document.querySelectorAll('.funnel-filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                triggerClientTableRender();
            }
        });

        document.getElementById('mass-whatsapp-btn').addEventListener('click', async () => {
    const selected = document.querySelectorAll('.client-checkbox:checked');
    if (selected.length === 0) {
        alert('Selecione pelo menos um cliente para o envio.');
        return;
    }

    if (!confirm(`Você está prestes a iniciar o envio de mensagens para ${selected.length} cliente(s) com pausas aleatórias entre eles. Deseja continuar?`)) {
        return;
    }

    // O loop 'for...of' nos permite usar 'await' (a pausa) dentro dele.
    for (const checkbox of selected) {
        const phone = (checkbox.dataset.phone || '').replace(/\D/g, '');
        const client = db.clients.find(c => (c.phone || '').replace(/\D/g, '') === phone);

        if (client) {
            const randomMessageIndex = Math.floor(Math.random() * messageTemplates.length);
            const randomEmojiIndex = Math.floor(Math.random() * emojis.length);

            let baseMessage = messageTemplates[randomMessageIndex];
            const emoji = emojis[randomEmojiIndex];

            const personalizedMessage = baseMessage.replace(/\[nome\]/gi, client.name.split(' ')[0]) + ' ' + emoji;

            const url = `https://wa.me/${phone}?text=${encodeURIComponent(personalizedMessage)}`;
            window.open(url, '_blank');

            client.lastContact = new Date().toISOString().slice(0, 10);

            // --- A MÁGICA ACONTECE AQUI ---
            // Define um tempo de espera aleatório entre 3 e 7 segundos
            const delay = 3000 + Math.random() * 4000; // 3000ms base + até 4000ms aleatórios
            console.log(`Aguardando ${Math.round(delay/1000)} segundos antes do próximo envio...`);

            // Executa a pausa
            await sleep(delay);
        }
    }

    // Ao final de todos os envios, salva os dados
    alert(`Envio para ${selected.length} cliente(s) finalizado!`);
    saveData();
    triggerClientTableRender();
});
        
        document.getElementById('select-all-clients').addEventListener('change', e => {
            document.querySelectorAll('.client-checkbox').forEach(cb => cb.checked = e.target.checked);
        });
        
        // ==========================================
        // GESTÃO DE IMÓVEIS
        // ==========================================
        const getPropertyFormHtml = (prop = {}) => {
            tempPropertyImages = prop.images ? [...prop.images] : [];
            tempMainImageIndex = (prop.mainImageIndex !== undefined && prop.mainImageIndex < tempPropertyImages.length) ? prop.mainImageIndex : -1;

            const incomeText = (prop.listPrice && prop.listPrice > 0) 
                ? `(Renda Mínima Estimada: ${formatCurrency(calculateMinimumIncomeForProperty(prop.listPrice))})`
                : '';

            const savedAmenities = prop.amenities || [];
            const amenitiesCheckboxes = db.amenities.map(amenity => `
                <div class="amenity-item">
                    <input type="checkbox" id="amenity-${amenity.name.replace(/\s/g, '-')}" name="amenities" value="${amenity.name}" ${savedAmenities.includes(amenity.name) ? 'checked' : ''}>
                    <label for="amenity-${amenity.name.replace(/\s/g, '-')}">${amenity.name}</label>
                </div>
            `).join('');
            
            return `
                <div class="form-grid">
                    <div class="form-group"><label for="prop-name">Nome do Imóvel/Empreendimento</label><input type="text" id="prop-name" value="${prop.name || ''}"></div>
                    <div class="form-group"><label for="prop-location">Localização</label><input type="text" id="prop-location" value="${prop.location || ''}"></div>
                    <div class="form-group"><label for="prop-list-price">Valor de Tabela (R$) ${incomeText}</label><input type="number" id="prop-list-price" value="${prop.listPrice || ''}"></div>
                    <div class="form-group"><label for="prop-eval-price">Valor de Avaliação (R$)</label><input type="number" id="prop-eval-price" value="${prop.evalPrice || ''}"></div>
                    <div class="form-group"><label for="prop-delivery-date">Data de Entrega</label><input type="date" id="prop-delivery-date" value="${prop.deliveryDate || ''}"></div>
                    <div class="form-group"><label for="prop-link">Link (Tour Virtual, Site)</label><input type="url" id="prop-link" value="${prop.link || ''}"></div>
                    <div class="form-group full-width"><label for="prop-video-link">Link do Vídeo (YouTube, Vimeo)</label><input type="url" id="prop-video-link" value="${prop.videoLink || ''}"></div>
                    <div class="form-group full-width"><label for="prop-description">Descrição Textual</label><textarea id="prop-description" placeholder="Use este campo para um texto de marketing, detalhes sobre a unidade, etc.">${prop.description || ''}</textarea></div>
                    
                    <div class="form-group full-width">
                        <label>Diferenciais e Comodidades</label>
                        <div class="amenities-container">
                            <input type="text" id="amenity-search-input" placeholder="Buscar diferencial..." style="margin-bottom: 10px; width: 100%;">
                            <div id="amenities-grid" class="amenities-grid">${amenitiesCheckboxes}</div>
                            <div class="add-amenity-toolbar">
                                <textarea id="new-amenity-input" placeholder="Cole uma lista de diferenciais (um por linha) ou digite um novo item para adicionar." rows="4"></textarea>
                                <button type="button" id="add-amenity-btn" class="btn-secondary" style="align-self: flex-start;"><i class="fas fa-cogs"></i> Processar</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label for="prop-images">Fotos do Imóvel (até 20) - Clique na estrela (⭐) para definir a foto principal do portfólio.</label>
                        <input type="file" id="prop-images" multiple accept="image/*">
                        <div id="prop-image-previews"></div>
                    </div>
                </div>
            `;
        };
        
        const renderPropertyPreviews = () => {
            const container = document.getElementById('prop-image-previews');
            if (!container) return;
            container.innerHTML = tempPropertyImages.map((imgData, index) => `
                <div class="img-preview-container">
                    <img src="${imgData}" alt="Pré-visualização ${index + 1}">
                    <button class="remove-img-btn" data-index="${index}">&times;</button>
                    <i class="fas fa-star main-image-selector ${index === tempMainImageIndex ? 'active' : ''}" data-index="${index}" title="Definir como foto principal"></i>
                </div>
            `).join('');
        };

        const handleImageSelection = (event) => {
            const files = event.target.files;
            if (!files) return;
            
            const totalImages = tempPropertyImages.length + files.length;
            if (totalImages > 20) {
                alert('Você pode enviar no máximo 20 imagens.');
                return;
            }

            const imagePromises = [];
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                imagePromises.push(new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 1024;
                            const scaleSize = (img.width > MAX_WIDTH) ? MAX_WIDTH / img.width : 1;
                            canvas.width = img.width * scaleSize;
                            canvas.height = img.height * scaleSize;

                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                            const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.75); 
                            resolve(compressedDataUrl);
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                }));
            }

            Promise.all(imagePromises).then(images => {
                tempPropertyImages = [...tempPropertyImages, ...images];
                if(tempMainImageIndex === -1 && tempPropertyImages.length > 0) tempMainImageIndex = 0;
                renderPropertyPreviews();
            }).catch(error => {
                console.error("Erro ao processar imagens:", error);
                alert("Ocorreu um erro ao carregar e comprimir as imagens.");
            });
        };
        
        const handleImagePreviewActions = (event) => {
            if (event.target.classList.contains('remove-img-btn')) {
                const index = parseInt(event.target.dataset.index, 10);
                tempPropertyImages.splice(index, 1);
                // Ajusta o índice da imagem principal se necessário
                if (tempMainImageIndex === index) {
                    tempMainImageIndex = tempPropertyImages.length > 0 ? 0 : -1;
                } else if (tempMainImageIndex > index) {
                    tempMainImageIndex--;
                }
                renderPropertyPreviews();
            } else if (event.target.classList.contains('main-image-selector')) {
                const index = parseInt(event.target.dataset.index, 10);
                tempMainImageIndex = index;
                renderPropertyPreviews();
            }
        };

        document.getElementById('add-property-btn').addEventListener('click', () => {
            openModal('Cadastrar Novo Imóvel', getPropertyFormHtml(), 'property');
            renderPropertyPreviews();
        });

        const renderPropertiesTable = (filter = '') => {
            const tbody = document.querySelector('#properties-table tbody');
            tbody.innerHTML = '';
            const filtered = db.properties.filter(p => 
                (p.name || '').toLowerCase().includes(filter.toLowerCase()) || 
                (p.location || '').toLowerCase().includes(filter.toLowerCase())
            );
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">Nenhum imóvel encontrado.</td></tr>'; return;
            }
            filtered.forEach(prop => {
                tbody.innerHTML += `
                    <tr>
                        <td><input type="checkbox" class="property-checkbox" data-id="${prop.id}"></td>
                        <td>${prop.name}</td>
                        <td>${formatCurrency(prop.listPrice)}</td>
                        <td>${formatCurrency(prop.evalPrice)}</td>
                        <td>${prop.location}</td>
                        <td class="action-buttons">
                             ${prop.images && prop.images.length > 0 ? `<button title="Ver Fotos" data-action="gallery" data-id="${prop.id}"><i class="fas fa-camera"></i></button>` : ''}
                            <button title="Visualizar Ficha" data-action="view" data-id="${prop.id}"><i class="fas fa-eye"></i></button>
                            <button title="Imprimir Ficha" data-action="print" data-id="${prop.id}"><i class="fas fa-print"></i></button>
                            <button title="Editar" data-action="edit" data-id="${prop.id}"><i class="fas fa-edit"></i></button>
                            <button title="Excluir" data-action="delete" data-id="${prop.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        };

        document.getElementById('property-search').addEventListener('input', e => renderPropertiesTable(e.target.value));

        document.querySelector('#properties-table tbody').addEventListener('click', e => {
            const button = e.target.closest('button');
            if (!button) return;
            const id = button.dataset.id;
            const action = button.dataset.action;
    
            if (action === 'edit') {
                const prop = db.properties.find(p => p.id == id);
                openModal('Editar Imóvel', getPropertyFormHtml(prop), 'property', id);
                renderPropertyPreviews();
            } else if (action === 'delete') {
                if (confirm(`Deseja realmente excluir o imóvel?`)) {
                    db.properties = db.properties.filter(p => p.id != id);
                    saveData();
                    renderPropertiesTable();
                }
            } else if (action === 'print') {
                const prop = db.properties.find(p => p.id == id);
                const forClient = confirm('Gerar versão para o cliente? (Ocultará valor de avaliação)');
                const propHtml = getPropertyDetailsHtml(id, forClient);
                const title = `Ficha do Imóvel: ${prop.name}`;
                printContent(propHtml, title);
            } else if (action === 'gallery') {
                openImageGallery({ entity: 'property', id: id });
            } else if (action === 'view') {
                 const prop = db.properties.find(p => p.id == id);
                 const propHtml = getPropertyDetailsHtml(id);
                 const modalBodyHtml = `
                    <div class="record-details">${propHtml}</div>
                    <div class="modal-footer" style="display:flex; justify-content: flex-end; margin-top: 1rem;">
                        <button class="btn-primary" id="print-modal-btn"><i class="fas fa-print"></i> Imprimir</button>
                    </div>`;
                 openModal(`Ficha de ${prop.name}`, modalBodyHtml, 'view', null, false);
                 document.getElementById('print-modal-btn').addEventListener('click', () => {
                    const forClient = confirm('Gerar versão para o cliente? (Ocultará valor de avaliação)');
                    const propPrintHtml = getPropertyDetailsHtml(id, forClient);
                    printContent(propPrintHtml, `Ficha do Imóvel: ${prop.name}`);
                 });
            }
        });

        document.getElementById('select-all-properties').addEventListener('change', e => {
            document.querySelectorAll('.property-checkbox').forEach(cb => cb.checked = e.target.checked);
        });
        
        // =========================================================
        // INÍCIO: LÓGICA PARA DIFERENCIAIS DINÂMICOS
        // =========================================================
        const getIconForAmenity = (name) => {
            const lowerName = name.toLowerCase();
            const iconMap = {
                'piscina': 'fas fa-swimming-pool', 'swimmer': 'fas fa-swimmer',
                'playground': 'fas fa-puzzle-piece', 'festa': 'fas fa-birthday-cake',
                'gourmet': 'fas fa-utensils', 'kids': 'fas fa-shapes',
                'criança': 'fas fa-child', 'pet': 'fas fa-paw',
                'bicicleta': 'fas fa-bicycle', 'academia': 'fas fa-dumbbell',
                'ginástica': 'fas fa-dumbbell', 'câmera': 'fas fa-video',
                'cftv': 'fas fa-video', 'segurança': 'fas fa-shield-alt',
                'reciclagem': 'fas fa-recycle', 'coleta': 'fas fa-recycle',
                'lazer': 'fas fa-dice', 'varanda': 'fas fa-archway',
                'ar condicionado': 'fas fa-wind', 'água': 'fas fa-tint',
                'wi-fi': 'fas fa-wifi', 'internet': 'fas fa-wifi',
                'luz': 'fas fa-lightbulb', 'energia': 'fas fa-bolt',
                'descarga': 'fas fa-toilet', 'cozinha': 'fas fa-utensils',
                'granito': 'fas fa-gem', 'mármore': 'fas fa-gem',
                'piso': 'fas fa-layer-group', 'churrasqueira': 'fas fa-cloud-meatball',
                'quadra': 'fas fa-futbol', 'esporte': 'fas fa-running',
                'jardim': 'fas fa-leaf', 'cinema': 'fas fa-film',
                'sauna': 'fas fa-hot-tub', 'escritório': 'fas fa-briefcase',
                'coworking': 'fas fa-briefcase', 'lavanderia': 'fas fa-tshirt',
                'portaria': 'fas fa-door-closed', 'elevador': 'fas fa-caret-square-up'
            };

            for (const keyword in iconMap) {
                if (lowerName.includes(keyword)) {
                    return iconMap[keyword];
                }
            }
            return 'fas fa-check-square'; // Default icon
        };
        
        modalBody.addEventListener('click', e => {
            if (e.target.id !== 'add-amenity-btn') return;

            const input = document.getElementById('new-amenity-input');
            const grid = document.getElementById('amenities-grid');
            const pastedText = input.value.trim();

            if (!pastedText) {
                alert('Por favor, digite ou cole os itens na caixa de texto.');
                return;
            }

            const itemsToProcess = pastedText.split('\n')
                                             .map(item => item.trim())
                                             .filter(item => item.length > 0);

            let newItemsWereAddedToDB = false;

            itemsToProcess.forEach(itemName => {
                const existingAmenity = db.amenities.find(a => a.name.toLowerCase() === itemName.toLowerCase());
                
                if (existingAmenity) {
                    const checkboxId = `amenity-${existingAmenity.name.replace(/\s/g, '-')}`;
                    const checkbox = document.getElementById(checkboxId);
                    if (checkbox) checkbox.checked = true;
                } else {
                    const newAmenity = { name: itemName, icon: getIconForAmenity(itemName) };
                    db.amenities.push(newAmenity);
                    newItemsWereAddedToDB = true;

                    const newAmenityId = `amenity-${itemName.replace(/\s/g, '-')}`;
                    const newItemHtml = `
                        <div class="amenity-item">
                            <input type="checkbox" id="${newAmenityId}" name="amenities" value="${itemName}" checked>
                            <label for="${newAmenityId}">${itemName}</label>
                        </div>
                    `;
                    grid.insertAdjacentHTML('beforeend', newItemHtml);
                }
            });

            if (newItemsWereAddedToDB) saveData(); 

            input.value = '';
            alert(`${itemsToProcess.length} item(ns) processado(s) com sucesso!`);
        });
        
        modalBody.addEventListener('input', e => {
            if (e.target.id === 'amenity-search-input') {
                const searchTerm = e.target.value.toLowerCase();
                const amenitiesGrid = document.getElementById('amenities-grid');
                if (!amenitiesGrid) return;

                const items = amenitiesGrid.querySelectorAll('.amenity-item');
                items.forEach(item => {
                    const label = item.querySelector('label');
                    if (label) {
                        const labelText = label.textContent.toLowerCase();
                        item.style.display = labelText.includes(searchTerm) ? 'flex' : 'none';
                    }
                });
            }
        });

        // ==========================================
        // GALERIA DE IMAGENS (AGORA GENÉRICA)
        // ==========================================
        const galleryModal = document.getElementById('image-gallery-modal');
        const galleryImage = document.getElementById('gallery-current-image');
        const galleryContainer = document.getElementById('gallery-image-container');
        const galleryCounter = document.getElementById('gallery-counter');
        let currentImageIndex = 0;
        let currentImages = [];

        const openImageGallery = (options) => {
            let imagesToShow = [];
            let startIndex = options.startIndex || 0;

            if (options.entity === 'property') {
                const property = db.properties.find(p => p.id == options.id);
                if (property && property.images && property.images.length > 0) {
                    imagesToShow = property.images;
                }
            } else if (options.entity === 'note') {
                const note = db.knowledgeBase.find(n => n.id == options.id);
                if (note && note.images && note.images.length > 0) {
                    imagesToShow = note.images;
                }
            }

            if (imagesToShow.length === 0) return;
            
            currentImages = imagesToShow;
            currentImageIndex = startIndex;
            updateGalleryView();
            galleryModal.classList.add('active');
        };

        const updateGalleryView = () => {
            galleryImage.src = currentImages[currentImageIndex];
            galleryCounter.textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
        };

        const changeImage = (direction) => {
            currentImageIndex += direction;
            if (currentImageIndex >= currentImages.length) { currentImageIndex = 0; }
            if (currentImageIndex < 0) { currentImageIndex = currentImages.length - 1; }
            updateGalleryView();
        };
        
        document.getElementById('gallery-next').addEventListener('click', () => changeImage(1));
        document.getElementById('gallery-prev').addEventListener('click', () => changeImage(-1));
        document.getElementById('gallery-close').addEventListener('click', () => galleryModal.classList.remove('active'));
        document.getElementById('gallery-fullscreen').addEventListener('click', () => {
            if (!document.fullscreenElement) {
                galleryContainer.requestFullscreen().catch(err => {
                    alert(`Erro ao entrar em tela cheia: ${err.message} (${err.name})`);
                });
            } else {
                document.exitFullscreen();
            }
        });
        
        // ==========================================
        // GESTÃO DA AGENDA (CALENDÁRIO)
        // ==========================================
        const getEventFormHtml = (event = {}, date = '') => {
            const clientOptions = db.clients.map(client => 
                `<option value="${client.id}" ${event.clientId == client.id ? 'selected' : ''}>${client.name}</option>`
            ).join('');

            return `
                <div class="form-grid">
                    <div class="form-group"><label for="event-title">Título</label><input type="text" id="event-title" value="${event.title || ''}"></div>
                    <div class="form-group"><label for="event-client">Associar ao Cliente (Opcional)</label><select id="event-client"><option value="">Nenhum</option>${clientOptions}</select></div>
                    <div class="form-group"><label for="event-date">Data</label><input type="date" id="event-date" value="${event.date || date}"></div>
                    <div class="form-group"><label for="event-time">Hora</label><input type="time" id="event-time" value="${event.time || ''}"></div>
                    <div class="form-group">
                        <label for="event-recurrence">Recorrência</label>
                        <select id="event-recurrence">
                            <option value="none" ${!event.recurrence || event.recurrence === 'none' ? 'selected' : ''}>Nunca</option>
                            <option value="daily" ${event.recurrence === 'daily' ? 'selected' : ''}>Diariamente</option>
                            <option value="weekly" ${event.recurrence === 'weekly' ? 'selected' : ''}>Semanalmente</option>
                            <option value="monthly" ${event.recurrence === 'monthly' ? 'selected' : ''}>Mensalmente</option>
                        </select>
                    </div>
                    <div class="form-group"><label for="event-end-date">Data Final da Recorrência (Opcional)</label><input type="date" id="event-end-date" value="${event.endDate || ''}"></div>
                    <div class="form-group full-width"><label for="event-description">Descrição</label><textarea id="event-description">${event.description || ''}</textarea></div>
                </div>
            `;
        };

        document.getElementById('add-event-btn').addEventListener('click', () => {
            const today = new Date().toISOString().slice(0, 10);
            openModal('Novo Compromisso', getEventFormHtml({}, today), 'event');
        });

        const getEventsForDate = (targetDate) => {
            const eventsOnDay = [];
            const targetDateObj = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());

            db.events.forEach(event => {
                if (!event.date) return;
                const startDate = new Date(event.date + 'T00:00:00');
                const endDate = event.endDate ? new Date(event.endDate + 'T00:00:00') : null;

                if (targetDateObj < startDate || (endDate && targetDateObj > endDate)) return;

                let isMatch = false;
                switch (event.recurrence) {
                    case 'none':
                        if (startDate.getTime() === targetDateObj.getTime()) isMatch = true;
                        break;
                    case 'daily':
                        isMatch = true;
                        break;
                    case 'weekly':
                        if (startDate.getDay() === targetDateObj.getDay()) isMatch = true;
                        break;
                    case 'monthly':
                        if (startDate.getDate() === targetDateObj.getDate()) isMatch = true;
                        break;
                    default:
                        if (startDate.getTime() === targetDateObj.getTime()) isMatch = true;
                }
                if (isMatch) eventsOnDay.push({ ...event, type: 'event' });
            });

            db.financialRecords.forEach(record => {
                record.payments.forEach((payment, index) => {
                    const paymentDate = new Date(payment.date + 'T00:00:00');
                    if (paymentDate.getTime() === targetDateObj.getTime()) {
                         eventsOnDay.push({
                            id: `${record.id}-${index}`,
                            title: record.description,
                            value: record.value,
                            type: record.type === 'income' ? 'income' : 'expense'
                        });
                    }
                });
            });

            return eventsOnDay;
        };


        const renderAgendaCalendar = () => {
            const grid = document.getElementById('calendar-grid');
            const monthYearEl = document.getElementById('month-year');
            const weekdaysEl = document.getElementById('weekdays');

            grid.innerHTML = '';
            weekdaysEl.innerHTML = '';
            
            const month = currentCalendarDate.getMonth();
            const year = currentCalendarDate.getFullYear();
            
            monthYearEl.textContent = new Date(year, month).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].forEach(day => weekdaysEl.innerHTML += `<div>${day}</div>`);

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();

            for (let i = 0; i < firstDayOfMonth; i++) {
                grid.innerHTML += `<div class="calendar-day other-month"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = date.toISOString().slice(0, 10);
                const isToday = date.toDateString() === today.toDateString();

                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                if(isToday) dayDiv.classList.add('today');
                dayDiv.dataset.date = dateString;
                dayDiv.innerHTML = `<div class="day-number">${day}</div><div class="events-container"></div>`;
                
                const eventsOnThisDay = getEventsForDate(date);
                const eventsContainer = dayDiv.querySelector('.events-container');

                eventsOnThisDay.forEach(event => {
                    const eventPill = document.createElement('div');
                    eventPill.className = 'event-pill';
                    eventPill.textContent = event.title;
                    
                    if (event.type === 'event') {
                        eventPill.dataset.eventId = event.id;
                        if(event.completed) eventPill.classList.add('completed');
                        const eventDateTime = new Date(`${event.date}T${event.time || '23:59:59'}`);
                        if(!event.completed && eventDateTime < today) eventPill.classList.add('overdue');
                    } else if (event.type === 'income') {
                        eventPill.classList.add('event-pill-income');
                        eventPill.innerHTML = `<i class="fas fa-arrow-up"></i> ${event.title}`;
                    } else if (event.type === 'expense') {
                         eventPill.classList.add('event-pill-expense');
                         eventPill.innerHTML = `<i class="fas fa-arrow-down"></i> ${event.title}`;
                    }
                    
                    eventsContainer.appendChild(eventPill);
                });

                grid.appendChild(dayDiv);
            }
        };

        document.getElementById('prev-month-btn').addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderAgendaCalendar();
        });

        document.getElementById('next-month-btn').addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderAgendaCalendar();
        });

        document.getElementById('calendar-grid').addEventListener('click', e => {
            const dayElement = e.target.closest('.calendar-day');
            if (!dayElement) return;

            const date = dayElement.dataset.date;
            
            if(e.target.classList.contains('event-pill') && e.target.dataset.eventId) {
                const eventId = e.target.dataset.eventId;
                const event = db.events.find(ev => ev.id == eventId);
                if(event) openModal('Editar Compromisso', getEventFormHtml(event), 'event', eventId);
                return;
            }

            const eventsOnDay = db.events.filter(ev => {
                 if (!ev.date) return false;
                 const eventDate = new Date(ev.date + 'T00:00:00');
                 return eventDate.toISOString().slice(0,10) === date;
            });

            const clientsBirthday = db.clients.filter(client => {
                if (!client.birthdate) return false;
                const birthDate = new Date(client.birthdate + 'T00:00:00');
                const clickedDate = new Date(date + 'T00:00:00');
                return birthDate.getDate() === clickedDate.getDate() && birthDate.getMonth() === clickedDate.getMonth();
            });

            if (eventsOnDay.length === 0 && clientsBirthday.length === 0) {
                 openModal('Novo Compromisso', getEventFormHtml({}, date), 'event');
            } else {
                openDayEventsModal(date, eventsOnDay, clientsBirthday);
            }
        });
        
        const openDayEventsModal = (date, events, birthdays) => {
            let content = '<div class="day-events-list">';
            const now = new Date();
            
            if (birthdays.length > 0) {
                content += '<h3><i class="fas fa-birthday-cake"></i> Aniversariantes</h3>';
                birthdays.forEach(client => {
                    content += `<div class="birthday-item event-item">Parabéns para <strong>${client.name}</strong>! <a href="https://wa.me/${(client.phone || '').replace(/\D/g, '')}?text=Olá, ${client.name.split(' ')[0]}! Parabéns pelo seu aniversário!" target="_blank"><i class="fab fa-whatsapp"></i> Enviar mensagem</a></div>`;
                });
            }

            if (events.length > 0) {
                content += '<h3>Compromissos</h3>';
                events.sort((a,b) => (a.time || '').localeCompare(b.time || ''));

                events.forEach(event => {
                    const client = db.clients.find(c => c.id == event.clientId);
                    const eventDateTime = new Date(`${event.date}T${event.time || '00:00:00'}`);
                    const isOverdue = !event.completed && eventDateTime < now;
                    
                    content += `
                        <div class="event-item ${event.completed ? 'completed' : ''} ${isOverdue ? 'overdue' : ''}" data-id="${event.id}">
                            <h4>${event.title} - ${event.time || 'horário não definido'}</h4>
                            <p>${event.description}</p>
                            ${client ? `<p><strong>Cliente:</strong> ${client.name}</p>` : ''}
                            <div class="action-buttons" style="margin-top: 10px;">
                                <button title="${event.completed ? 'Marcar como não concluído' : 'Marcar como concluído'}" data-action="toggle-complete"><i class="fas fa-check-circle"></i></button>
                                <button title="Editar" data-action="edit"><i class="fas fa-edit"></i></button>
                                <button title="Excluir" data-action="delete"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                });
            }
            content += '</div>';
            openModal(`Eventos de ${formatDate(date)}`, content, 'day-view', null, false);
        };
        
        modalBody.addEventListener('click', e => {
            if(currentEntityType !== 'day-view') return;
            
            const button = e.target.closest('button');
            if (!button) return;
            
            const eventItem = button.closest('.event-item');
            if(!eventItem) return;
            const id = eventItem.dataset.id;
            const action = button.dataset.action;
            const event = db.events.find(ev => ev.id == id);
            
            if (action === 'edit') {
                closeModal();
                openModal('Editar Compromisso', getEventFormHtml(event), 'event', id);
            } else if (action === 'delete') {
                if (confirm('Deseja excluir este compromisso?')) {
                    db.events = db.events.filter(ev => ev.id != id);
                    saveData();
                    closeModal();
                    renderAgendaCalendar();
                }
            } else if (action === 'toggle-complete') {
                event.completed = !event.completed;
                saveData();
                closeModal();
                renderAgendaCalendar();
            }
        });

         // ==========================================
        // GESTÃO DE LINKS ÚTEIS (COM ENCURTADOR)
        // ==========================================
        const getLinkFormHtml = (link = {}) => {
            return `
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="link-title">Título</label>
                        <input type="text" id="link-title" value="${link.title || ''}" placeholder="Ex: Portal Zap Imóveis">
                    </div>
                    <div class="form-group full-width">
                        <label for="link-url">URL (Endereço do Site)</label>
                        <input type="url" id="link-url" value="${link.url || ''}" placeholder="https://www.zapimoveis.com.br">
                    </div>
                </div>
            `;
        };

        document.getElementById('add-link-btn').addEventListener('click', () => {
            openModal('Adicionar Novo Link', getLinkFormHtml(), 'link');
        });

        const renderLinksTable = () => {
            const tbody = document.querySelector('#links-table tbody');
            tbody.innerHTML = '';

            if (!db.usefulLinks || db.usefulLinks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3">Nenhum link cadastrado.</td></tr>';
                return;
            }

            db.usefulLinks.forEach(link => {
                const shortUrl = link.shortUrl || link.url; // Fallback para links antigos
                tbody.innerHTML += `
                    <tr>
                        <td>${link.title}</td>
                        <td><a href="${shortUrl}" target="_blank">${shortUrl}</a></td>
                        <td class="action-buttons">
                            <a href="${shortUrl}" target="_blank" class="btn-link" title="Abrir Link"><i class="fas fa-external-link-alt"></i></a>
                            <button title="Copiar Link Curto" data-action="copy" data-short-url="${shortUrl}"><i class="fas fa-copy"></i></button>
                            <button title="Editar" data-action="edit" data-id="${link.id}"><i class="fas fa-edit"></i></button>
                            <button title="Excluir" data-action="delete" data-id="${link.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        };
        
        document.querySelector('#links-table tbody').addEventListener('click', e => {
            const button = e.target.closest('button');
            if (!button) return;
            const id = button.dataset.id;
            const action = button.dataset.action;

            if (action === 'edit') {
                const link = db.usefulLinks.find(l => l.id == id);
                openModal('Editar Link', getLinkFormHtml(link), 'link', id);
            } else if (action === 'delete') {
                if (confirm(`Deseja realmente excluir o link?`)) {
                    db.usefulLinks = db.usefulLinks.filter(l => l.id != id);
                    saveData();
                    renderLinksTable();
                }
            } else if (action === 'copy') {
                const urlToCopy = button.dataset.shortUrl;
                navigator.clipboard.writeText(urlToCopy).then(() => {
                    showToast('Link curto copiado!');
                }).catch(err => {
                    console.error('Falha ao copiar:', err);
                    showToast('Erro ao copiar o link.');
                });
            }
        });

        
        // ==========================================
        // CÁLCULOS E ANÁLISE DE FINANCIAMENTO
        // ==========================================
        const calculateMinimumIncomeForProperty = (propertyPrice) => {
            if (!propertyPrice || propertyPrice <= 0) return 0;
            const P = propertyPrice * 0.80; 
            const r = (1 + 0.05)**(1/12) - 1; 
            const n = 420; 
            const pmt = (P * r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
            const requiredIncome = pmt / 0.30;
            return requiredIncome;
        };

        const calculateFinancing = (client, property) => {
            if (!client || !property || !client.income || !client.birthdate || !property.listPrice) {
                return { error: 'Dados insuficientes. Verifique se o cliente possui renda, data de nascimento e um imóvel de interesse com valor cadastrado.' };
            }

            const clientAgeInMonths = getAgeInMonths(client.birthdate);
            if (clientAgeInMonths === null) {
                return { error: 'Data de nascimento do cliente é inválida.' };
            }
            
            const MAX_AGE_MONTHS = 966; // 80 anos e 6 meses
            const MAX_TERM_MONTHS = 420; // 35 anos
            const INTEREST_RATE_YEARLY = 0.05;
            const MAX_LOAN_TO_VALUE = 0.80; // 80%
            const MAX_DEBT_TO_INCOME = 0.30; // 30%

            const maxTermByAge = MAX_AGE_MONTHS - clientAgeInMonths;
            if (maxTermByAge <= 0) {
                return { error: 'Cliente acima da idade máxima para financiamento.' };
            }

            const finalTerm = Math.min(MAX_TERM_MONTHS, maxTermByAge);
            const monthlyInterestRate = (1 + INTEREST_RATE_YEARLY)**(1/12) - 1; 
            
            const maxLoanFromBank = property.listPrice * MAX_LOAN_TO_VALUE;
            const maxAffordablePayment = client.income * MAX_DEBT_TO_INCOME;

            const requiredPaymentForMaxLoan = (maxLoanFromBank * monthlyInterestRate) / (1 - Math.pow(1 + monthlyInterestRate, -finalTerm));
            const isCompatible = requiredPaymentForMaxLoan <= maxAffordablePayment;
            let approvedLoanAmount, requiredDownPayment;

            if (isCompatible) {
                approvedLoanAmount = maxLoanFromBank;
                requiredDownPayment = property.listPrice - approvedLoanAmount;
            } else {
                approvedLoanAmount = (maxAffordablePayment / monthlyInterestRate) * (1 - Math.pow(1 + monthlyInterestRate, -finalTerm));
                requiredDownPayment = property.listPrice - approvedLoanAmount;
            }

            return {
                isCompatible, clientIncome: client.income, propertyValue: property.listPrice,
                maxAffordablePayment, requiredPaymentForMaxLoan, approvedLoanAmount, requiredDownPayment,
                finalTerm: Math.floor(finalTerm), standardDownPayment: property.listPrice * (1 - MAX_LOAN_TO_VALUE)
            };
        };

        const getFinancingAnalysisHtml = (analysis, clientName, propertyName) => {
             if (analysis.error) {
                return `<div class="analysis-result"><p class="highlight-danger">${analysis.error}</p></div>`;
            }
            
            const resultClass = analysis.isCompatible ? 'highlight-success' : 'highlight-danger';
            const resultText = analysis.isCompatible ? 'RENDA COMPATÍVEL' : 'RENDA INSUFICIENTE PARA FINANCIAMENTO DE 80%';

            return `
                <div class="analysis-result">
                    <h4>Análise para <strong>${clientName}</strong> | Imóvel: <strong>${propertyName}</strong></h4><hr>
                    <p><strong>Valor do Imóvel:</strong> ${formatCurrency(analysis.propertyValue)}</p>
                    <p><strong>Renda do Cliente:</strong> ${formatCurrency(analysis.clientIncome)}</p>
                    <p><strong>Parcela Máxima Suportada (30%):</strong> ${formatCurrency(analysis.maxAffordablePayment)}</p>
                    <p><strong>Prazo Máximo de Financiamento:</strong> ${analysis.finalTerm} meses (${Math.floor(analysis.finalTerm / 12)} anos)</p><hr>
                    <h4>Resultado da Simulação</h4>
                    <p><strong>Parcela Estimada para 80% do Imóvel:</strong> ${formatCurrency(analysis.requiredPaymentForMaxLoan)}</p>
                    <p><strong>Resultado:</strong> <span class="${resultClass}">${resultText}</span></p><br>
                    <p><strong>Valor Máximo de Financiamento Aprovado:</strong> ${formatCurrency(analysis.approvedLoanAmount)}</p>
                    <p><strong>ENTRADA ESTIMADA NECESSÁRIA:</strong> <strong class="${resultClass}">${formatCurrency(analysis.requiredDownPayment)}</strong></p>
                    ${!analysis.isCompatible ? `<p><small>(A entrada padrão de 20% seria de ${formatCurrency(analysis.standardDownPayment)})</small></p>` : ''}
                </div>
            `;
        };
        
        const handleFinancingAnalysis = (clientId) => {
            const client = db.clients.find(c => c.id == clientId);
            const property = db.properties.find(p => p.id == client.propertyId);

            if (!property) {
                alert('Este cliente não está associado a um imóvel de interesse. Edite o cadastro do cliente para selecionar um.');
                return;
            }
            
            const analysis = calculateFinancing(client, property);
            const modalHtml = getFinancingAnalysisHtml(analysis, client.name, property.name);
            openModal('Análise de Financiamento', modalHtml, 'analysis', null, false);
        };
        
        // ==========================================
        // GESTÃO FINANCEIRA & BI (COM NOVAS REGRAS)
        // ==========================================
        const getFinancialRecordFormHtml = (record = {}, type = 'income', paymentDate = null) => {
            let paymentHtml = '';
            if (paymentDate) {
                paymentHtml = `
                    <div class="payment-status-section">
                        <h4>Confirmar Pagamento</h4>
                        <p>Deseja marcar o lançamento de <strong>${formatCurrency(record.value)}</strong> com vencimento em <strong>${formatDate(paymentDate)}</strong> como pago?</p>
                        <button type="button" id="confirm-payment-btn" class="btn-success"><i class="fas fa-check-circle"></i> Sim, Confirmar Pagamento</button>
                    </div>
                `;
            }

            return `
                ${getFinancialRecordFormHtml.content = /*html*/`
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="fin-description">Descrição</label>
                        <input type="text" id="fin-description" value="${record.description || ''}" placeholder="${type === 'income' ? 'Ex: Comissão Venda Apto 101' : 'Ex: Parcela do carro'}">
                    </div>
                    <div class="form-group">
                        <label for="fin-value">Valor (R$)</label>
                        <input type="number" id="fin-value" value="${record.value || ''}">
                    </div>
                    <div class="form-group">
                        <label for="fin-category">Categoria</label>
                        <input type="text" id="fin-category" value="${record.category || ''}" placeholder="${type === 'income' ? 'Comissão, Aluguel...' : 'Marketing, Transporte...'}">
                    </div>
                    <div class="form-group">
                        <label for="fin-start-date">Data de Início / Vencimento</label>
                        <input type="date" id="fin-start-date" value="${record.startDate || new Date().toISOString().slice(0, 10)}">
                    </div>
                    <div class="form-group">
                        <label for="fin-recurrence">Tipo de Lançamento</label>
                        <select id="fin-recurrence">
                            <option value="none" ${!record.recurrence || record.recurrence === 'none' ? 'selected' : ''}>Único ou Parcelado</option>
                            <option value="monthly" ${record.recurrence === 'monthly' ? 'selected' : ''}>Recorrente Mensal</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fin-installments">Nº de Parcelas</label>
                        <input type="number" id="fin-installments" value="${record.totalInstallments || 1}" min="1">
                    </div>
                </div>
                ${paymentHtml}
                `}
            `;
        };

        document.getElementById('add-income-btn').addEventListener('click', () => {
            openModal('Registrar Nova Receita', getFinancialRecordFormHtml({}, 'income'), 'financialRecord', 'income');
        });
        document.getElementById('add-expense-btn').addEventListener('click', () => {
            openModal('Registrar Nova Despesa', getFinancialRecordFormHtml({}, 'expense'), 'financialRecord', 'expense');
        });
        
        const renderFinancialRecordsTable = () => {
            const tbody = document.querySelector('#financial-records-table tbody');
            tbody.innerHTML = '';

            const sortedRecords = [...db.financialRecords].sort((a,b) => new Date(b.startDate) - new Date(a.startDate));

            if (sortedRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">Nenhum lançamento financeiro registrado.</td></tr>';
                return;
            }

            sortedRecords.forEach(record => {
                const typeClass = record.type === 'income' ? 'highlight-success' : 'highlight-danger';
                const typeText = record.type === 'income' ? 'Receita' : 'Despesa';
                const recurrenceText = record.recurrence === 'monthly' 
                    ? ' (Mensal)' 
                    : (record.totalInstallments > 1 ? ` (${record.totalInstallments}x)` : '');
                
                tbody.innerHTML += `
                    <tr>
                        <td>${formatDate(record.startDate)}</td>
                        <td>${record.description}${recurrenceText}</td>
                        <td>${record.category}</td>
                        <td><span class="${typeClass}">${typeText}</span></td>
                        <td><span class="${typeClass}">${formatCurrency(record.value)}</span></td>
                        <td class="action-buttons">
                            <button title="Editar" data-action="edit" data-id="${record.id}"><i class="fas fa-edit"></i></button>
                            <button title="Excluir" data-action="delete" data-id="${record.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        };

        document.querySelector('#financial-records-table').addEventListener('click', e => {
            const button = e.target.closest('button');
            if (!button) return;
            const id = button.dataset.id;
            const action = button.dataset.action;

            if(action === 'edit') {
                const record = db.financialRecords.find(r => r.id == id);
                const type = record.type;
                openModal(`Editar Lançamento`, getFinancialRecordFormHtml(record, type), 'financialRecord', id);
            } else if (action === 'delete') {
                if(confirm('Tem certeza que deseja excluir este lançamento?')) {
                    db.financialRecords = db.financialRecords.filter(r => r.id != id);
                    saveData();
                    renderFinancialRecordsTable();
                    renderFinancialBI();
                }
            }
        });
        
        const renderFinancialBI = () => {
            const container = document.getElementById('financial-bi-content');
            
            let realizedRevenue = 0;
            let realizedExpense = 0;

            db.financialRecords.forEach(record => {
                record.payments.forEach(payment => {
                    if (payment.status === 'paid') {
                        if (record.type === 'income') realizedRevenue += record.value;
                        else realizedExpense += record.value;
                    }
                });
            });
            
            const balance = realizedRevenue - realizedExpense;
            const financialAlerts = getFinancialAlerts(30);
            const futureRevenue = financialAlerts.filter(a => a.type === 'income').reduce((sum, a) => sum + a.value, 0);
            const futureExpense = financialAlerts.filter(a => a.type === 'expense').reduce((sum, a) => sum + a.value, 0);

            container.innerHTML = `
                <div class="financial-card metric-card">
                    <div class="metric-card-content">
                        <i class="fas fa-arrow-up metric-icon" style="color:var(--success-color); background-color:#eafaf1;"></i>
                        <div>
                            <h3>Receita Realizada (Recebida)</h3>
                            <p class="metric-value" style="color:var(--success-color);">${formatCurrency(realizedRevenue)}</p>
                        </div>
                    </div>
                </div>
                 <div class="financial-card metric-card">
                    <div class="metric-card-content">
                        <i class="fas fa-arrow-down metric-icon" style="color:var(--danger-color); background-color:#fbeee C;"></i>
                        <div>
                            <h3>Despesa Realizada (Paga)</h3>
                            <p class="metric-value" style="color:var(--danger-color);">${formatCurrency(realizedExpense)}</p>
                        </div>
                    </div>
                </div>
                 <div class="financial-card metric-card">
                    <div class="metric-card-content">
                        <i class="fas fa-balance-scale metric-icon"></i>
                        <div>
                            <h3>Saldo Atual</h3>
                            <p class="metric-value">${formatCurrency(balance)}</p>
                        </div>
                    </div>
                </div>
                 <div class="financial-card metric-card">
                    <div class="metric-card-content">
                        <i class="fas fa-calendar-alt metric-icon"></i>
                        <div>
                            <h3>Próximos 30 dias (a vencer)</h3>
                            <p style="color:var(--success-color);">+ ${formatCurrency(futureRevenue)}</p>
                            <p style="color:var(--danger-color);">- ${formatCurrency(futureExpense)}</p>
                        </div>
                    </div>
                </div>
            `;
        };

        // ==========================================
        // GESTÃO DE CONFIGURAÇÕES
        // ==========================================
        const renderSettings = () => {
            document.getElementById('setting-broker-name').value = db.settings.brokerName;
            document.getElementById('setting-broker-creci').value = db.settings.brokerCreci;
            document.getElementById('setting-broker-phone').value = db.settings.brokerPhone;
            document.getElementById('setting-leads-goal').value = db.settings.goals.leads;
            document.getElementById('setting-revenue-goal').value = db.settings.goals.revenue;
            document.getElementById('setting-default-commission').value = db.settings.defaultCommission;
            renderFunnelEditor();
            renderAmenitiesList();
        };

        const renderAmenitiesList = () => {
            const container = document.getElementById('amenities-list');
            if(!container) return;
            container.innerHTML = '';
            db.amenities.forEach(amenity => {
                container.innerHTML += `
                    <div class="amenity-list-item" data-name="${amenity.name}">
                        <span>${amenity.name}</span>
                        <button class="delete-amenity-btn"><i class="fas fa-trash"></i></button>
                    </div>
                `;
            });
        };

        document.getElementById('amenities-list')?.addEventListener('click', e => {
            const deleteBtn = e.target.closest('.delete-amenity-btn');
            if (deleteBtn) {
                const item = deleteBtn.closest('.amenity-list-item');
                const amenityName = item.dataset.name;
                if (confirm(`Tem certeza que deseja excluir o diferencial "${amenityName}" da lista padrão?`)) {
                    db.amenities = db.amenities.filter(a => a.name !== amenityName);
                    saveData();
                    renderAmenitiesList();
                }
            }
        });


        document.getElementById('save-broker-info').addEventListener('click', () => {
            db.settings.brokerName = document.getElementById('setting-broker-name').value;
            db.settings.brokerCreci = document.getElementById('setting-broker-creci').value;
            db.settings.brokerPhone = document.getElementById('setting-broker-phone').value;
            const logoFile = document.getElementById('setting-logo-upload').files[0];
            if (logoFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    db.settings.logoUrl = e.target.result;
                    saveData();
                    updateHeader();
                    alert('Dados do corretor e logo salvos!');
                };
                reader.readAsDataURL(logoFile);
            } else {
                saveData();
                updateHeader();
                alert('Dados do corretor salvos!');
            }
        });

        document.getElementById('save-goals').addEventListener('click', () => {
            db.settings.goals.leads = parseInt(document.getElementById('setting-leads-goal').value) || 0;
            db.settings.goals.revenue = parseFloat(document.getElementById('setting-revenue-goal').value) || 0;
            db.settings.defaultCommission = parseFloat(document.getElementById('setting-default-commission').value) || 5;
            saveData();
            alert('Metas salvas com sucesso!');
        });
        
        const renderFunnelEditor = () => {
            const container = document.getElementById('funnel-editor');
            container.innerHTML = '';
            db.funnelStages.forEach(stage => {
                container.innerHTML += `
                    <div class="stage-item" data-id="${stage.id}" draggable="true">
                        <i class="fas fa-grip-vertical" style="margin-right: 10px; color: #ccc;"></i>
                        <input type="text" class="stage-name-input" value="${stage.name}">
                        <input type="number" class="stage-prob-input" value="${stage.probability}" min="0" max="100"> %
                        <button class="delete-stage-btn"><i class="fas fa-trash"></i></button>
                    </div>
                `;
            });
        };
        
        const funnelEditor = document.getElementById('funnel-editor');
        let draggedItem = null;

        funnelEditor.addEventListener('dragstart', e => {
            draggedItem = e.target.closest('.stage-item');
            draggedItem.classList.add('dragging');
        });

        funnelEditor.addEventListener('dragend', e => {
            draggedItem.classList.remove('dragging');
            draggedItem = null;
        });

        funnelEditor.addEventListener('dragover', e => {
            e.preventDefault();
            const container = funnelEditor;
            const afterElement = getDragAfterElement(container, e.clientY);
            const currentDragging = document.querySelector('.dragging');
            if (afterElement == null) {
                container.appendChild(currentDragging);
            } else {
                container.insertBefore(currentDragging, afterElement);
            }
        });

        funnelEditor.addEventListener('drop', e => {
            const newOrderIds = [...funnelEditor.querySelectorAll('.stage-item')].map(item => Number(item.dataset.id));
            db.funnelStages.sort((a, b) => newOrderIds.indexOf(a.id) - newOrderIds.indexOf(b.id));
            saveData();
            renderFunnelFilters();
        });
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.stage-item:not(.dragging), .portfolio-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        document.getElementById('add-stage-btn').addEventListener('click', () => {
            const name = document.getElementById('new-stage-name').value;
            const prob = parseInt(document.getElementById('new-stage-prob').value);
            if (!name || isNaN(prob)) {
                alert('Preencha o nome e a probabilidade da etapa.'); return;
            }
            db.funnelStages.push({ id: Date.now(), name, probability: prob });
            saveData();
            renderFunnelEditor();
            document.getElementById('new-stage-name').value = '';
            document.getElementById('new-stage-prob').value = '';
        });

        funnelEditor.addEventListener('click', e => {
            if (e.target.closest('.delete-stage-btn')) {
                const id = e.target.closest('.stage-item').dataset.id;
                db.funnelStages = db.funnelStages.filter(s => s.id != id);
                saveData();
                renderFunnelEditor();
            }
        });
        
        funnelEditor.addEventListener('change', e => {
             if (e.target.classList.contains('stage-name-input') || e.target.classList.contains('stage-prob-input')) {
                const id = e.target.closest('.stage-item').dataset.id;
                const stage = db.funnelStages.find(s => s.id == id);
                if (e.target.classList.contains('stage-name-input')) {
                    stage.name = e.target.value;
                } else {
                    stage.probability = parseInt(e.target.value);
                }
                saveData();
             }
        });

        document.getElementById('clear-system-btn').addEventListener('click', () => {
            if (confirm('ATENÇÃO! Isso apagará TODOS os dados do sistema permanentemente. Deseja continuar?')) {
                dexieDb.delete().then(() => {
                    alert("Banco de dados apagado com sucesso.");
                    location.reload();
                }).catch((err) => {
                    console.error("Não foi possível apagar o banco de dados", err);
                    alert("Ocorreu um erro ao tentar limpar o sistema.");
                });
            }
        });

        document.getElementById('delete-duplicates-btn').addEventListener('click', () => {
            const uniqueClients = [];
            const seenPhones = new Set();
            db.clients.forEach(client => {
                if (!client.phone) { uniqueClients.push(client); return; }
                const phone = client.phone.replace(/\D/g, '');
                if (!seenPhones.has(phone)) {
                    seenPhones.add(phone);
                    uniqueClients.push(client);
                }
            });
            const removedCount = db.clients.length - uniqueClients.length;
            db.clients = uniqueClients;
            saveData();
            alert(`${removedCount} cliente(s) duplicado(s) foram removidos.`);
            triggerClientTableRender();
        });

        document.getElementById('export-backup-btn').addEventListener('click', () => {
            const dataStr = JSON.stringify(db, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_crm_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById('import-backup-btn').addEventListener('click', () => {
             document.getElementById('import-backup').click();
        });
        
        document.getElementById('import-backup').addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedDb = JSON.parse(event.target.result);
                    if (confirm('Isso substituirá todos os dados atuais. Deseja continuar?')) {
                        db = importedDb;
                        saveData();
                        location.reload();
                    }
                } catch (err) {
                    alert('Erro ao ler o arquivo de backup. Verifique se o arquivo é válido.');
                }
            };
            reader.readAsText(file);
        });
        
        document.getElementById('download-template-btn').addEventListener('click', () => {
            const clientTemplate = [{
                nome: "Exemplo Cliente", contato: "5582999998888", email: "cliente@exemplo.com", 
                cpf: "123.456.789-00", data_nascimento: "1990-01-15", renda: 5000, 
                valor_imovel_pretendido: 300000, comissao_personalizada: 6, origem: "patrocinado"
            }];
            const propertyTemplate = [{
                nome: "Exemplo Imóvel", localizacao: "Bairro Exemplo, Maceió",
                valor_tabela: 450000, valor_avaliacao: 460000, data_entrega: "2026-12-31",
                link: "https://site.com/imovel", descricao: "Apartamento de 3 quartos."
            }];
            
            const wb = XLSX.utils.book_new();
            const wsClients = XLSX.utils.json_to_sheet(clientTemplate);
            const wsProperties = XLSX.utils.json_to_sheet(propertyTemplate);
            XLSX.utils.book_append_sheet(wb, wsClients, "Clientes");
            XLSX.utils.book_append_sheet(wb, wsProperties, "Imoveis");
            XLSX.writeFile(wb, "modelo_importacao_crm.xlsx");
        });

        document.getElementById('import-btn').addEventListener('click', () => {
            const fileInput = document.getElementById('import-excel');
            const file = fileInput.files[0];
            const type = document.getElementById('import-type').value;
            if (!file) { alert('Selecione um arquivo para importar.'); return; }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates:true });
                    const sheetName = type === 'clients' ? "Clientes" : "Imoveis";
                    const worksheet = workbook.Sheets[sheetName];
                    if (!worksheet) { alert(`Aba "${sheetName}" não encontrada no arquivo.`); return; }
                    const json = XLSX.utils.sheet_to_json(worksheet);

                    if (type === 'clients') {
                        json.forEach(row => {
                            db.clients.push({
                                id: Date.now() + Math.random(), name: row.nome, phone: String(row.contato || ''), email: row.email,
                                cpf: String(row.cpf || ''), birthdate: row.data_nascimento, income: row.renda,
                                propertyValue: row.valor_imovel_pretendido, commission: row.comissao_personalizada,
                                leadSource: row.origem,
                                stageId: db.funnelStages[0]?.id || null, notes: '', lastContact: null
                            });
                        });
                    } else {
                         json.forEach(row => {
                            db.properties.push({
                                id: Date.now() + Math.random(), name: row.nome, location: row.localizacao,
                                listPrice: row.valor_tabela, evalPrice: row.valor_avaliacao, deliveryDate: row.data_entrega,
                                link: row.link, description: row.descricao, amenities: []
                            });
                        });
                    }
                    saveData();
                    alert(`${json.length} item(ns) importado(s) com sucesso!`);
                    
                    if (type === 'clients') { switchPanel('clients'); } else { switchPanel('properties'); }
                } catch(error) {
                    console.error("Erro na importação:", error);
                    alert("Ocorreu um erro ao importar a planilha. Verifique o formato do arquivo e os nomes das colunas.");
                } finally {
                    fileInput.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // ==========================================
        // GERAÇÃO DE CONTEÚDO DE FICHAS, PDFS E IMPRESSÃO
        // ==========================================
        const getPrintableHeaderHtml = () => {
            const broker = db.settings;
            return `
                <div class="printable-header">
                    <img src="${broker.logoUrl}" alt="Logo" class="printable-header-logo">
                    <div class="printable-header-info">
                        <h1>${broker.brokerName}</h1>
                        <p>${broker.brokerCreci}</p>
                        <p>Telefone: ${broker.brokerPhone}</p>
                    </div>
                </div>
            `;
        };
        
        // NOVO: Função de impressão atualizada para suportar QR Code
        const printContent = (contentHtml, title) => {
            const printArea = document.getElementById('print-area');
            const originalTitle = document.title;
            
            const fullHtml = `
                <div class="printable-document">
                    ${getPrintableHeaderHtml()}
                    <h1>${title}</h1>
                    <div class="record-details">${contentHtml}</div>
                </div>
            `;
            
            printArea.innerHTML = fullHtml;

            const qrContainer = printArea.querySelector('#property-qr-code-container');
            const linkSource = printArea.querySelector('.qr-code-for-print');

            // Verifica se existe um placeholder para o QR code e um link para gerar
            if (qrContainer && linkSource && linkSource.dataset.link) {
                qrContainer.innerHTML = ''; // Limpa o container
                // Gera o novo QR Code
                new QRCode(qrContainer, {
                    text: linkSource.dataset.link,
                    width: 128,
                    height: 128,
                    correctLevel: QRCode.CorrectLevel.H
                });

                // Adiciona um pequeno delay para garantir que o QR Code (que é uma imagem) seja renderizado no DOM
                setTimeout(() => {
                    document.title = title;
                    window.print();
                    printArea.innerHTML = '';
                    document.title = originalTitle;
                }, 250); // 250ms é um delay seguro
            } else {
                // Se não houver QR code, imprime imediatamente
                document.title = title;
                window.print();
                printArea.innerHTML = '';
                document.title = originalTitle;
            }
        };
        
        const getClientDetailsHtml = (id) => {
            const client = db.clients.find(c => c.id == id);
            const stage = db.funnelStages.find(s => s.id === client.stageId);
            const property = db.properties.find(p => p.id == client.propertyId);
            const propertyValue = property ? property.listPrice : client.propertyValue;
            const commission = client.commission || db.settings.defaultCommission;
            const commissionValue = (propertyValue * commission) / 100;
            const events = db.events.filter(e => e.clientId == id);
            
            let financingHtml = '';
            if (property) {
                const analysis = calculateFinancing(client, property);
                const analysisResultHtml = getFinancingAnalysisHtml(analysis, client.name, property.name)
                                           .replace(/<strong class="[^"]*">/g, '<strong>')
                                           .replace(/<span class="[^"]*">/g, '<strong><span>')
                                           .replace(/<\/span>/g, '</span></strong>');
                financingHtml = `<h3>Análise de Financiamento</h3>${analysisResultHtml}`;
            }

            return `
                <h3>Dados Pessoais</h3>
                <p><strong>Nome:</strong> ${client.name || ''}</p>
                <p><strong>Contato:</strong> ${client.phone || ''}</p>
                <p><strong>Email:</strong> ${client.email || ''}</p>
                <p><strong>CPF:</strong> ${client.cpf || ''}</p>
                <p><strong>Data de Nascimento:</strong> ${formatDate(client.birthdate)}</p>
                
                <h3>Dados Financeiros e de Interesse</h3>
                <p><strong>Renda Declarada:</strong> ${formatCurrency(client.income)}</p>
                <p><strong>Origem do Lead:</strong> ${client.leadSource || 'Não informada'}</p>
                <p><strong>Imóvel de Interesse:</strong> ${property ? property.name : 'Não selecionado'}</p>
                <p><strong>Valor do Imóvel:</strong> ${formatCurrency(propertyValue)}</p>
                <p><strong>Comissão (Potencial):</strong> ${formatCurrency(commissionValue)} (${commission}%)</p>
                
                <h3>Status no Funil</h3>
                <p><strong>Etapa Atual:</strong> ${stage ? stage.name : 'Não definida'}</p>

                <div class="toolbar">
                 <h3>Ações Rápidas</h3>
                    <button class="btn-secondary" data-action="schedule-call"><i class="fas fa-phone"></i> Agendar Ligação</button>
                    <button class="btn-secondary" data-action="schedule-message"><i class="fab fa-whatsapp"></i> Agendar Mensagem</button>
                </div>
                
                ${financingHtml}

                <h3>Histórico de Compromissos</h3>
                ${events.length > 0 ? events.map(e => `<p>${formatDate(e.date)} às ${e.time || ''} - ${e.title}</p>`).join('') : '<p>Nenhum compromisso registrado.</p>'}
            `;
        };
        
        // NOVO: Função de detalhes do imóvel atualizada para incluir placeholders para o QR Code
        const getPropertyDetailsHtml = (id, forClient = false) => {
            const prop = db.properties.find(p => p.id == id);
            const requiredIncome = (prop.listPrice && prop.listPrice > 0)
                ? calculateMinimumIncomeForProperty(prop.listPrice)
                : 0;
            
            let amenitiesHtml = '';
            if (prop.amenities && prop.amenities.length > 0) {
                const amenitiesItems = prop.amenities.map(amenityName => {
                    const amenityData = db.amenities.find(a => a.name === amenityName);
                    const iconClass = amenityData ? amenityData.icon : 'fas fa-check';
                    return `
                        <div class="amenity-display-item">
                            <i class="${iconClass}"></i>
                            <span>${amenityName}</span>
                        </div>
                    `;
                }).join('');
                amenitiesHtml = `
                    <h3>Diferenciais</h3>
                    <div class="amenities-display-grid">${amenitiesItems}</div>
                `;
            }
            
            let mainImageHtml = '';
            if (prop.images && prop.images.length > 0) {
                const mainImageIndex = prop.mainImageIndex >= 0 ? prop.mainImageIndex : 0;
                mainImageHtml = `<img src="${prop.images[mainImageIndex]}" alt="Foto principal de ${prop.name}" class="main-image">`;
            }

            let videoHtml = '';
            if(prop.videoLink) {
                const embedUrl = getEmbedUrl(prop.videoLink);
                if(embedUrl) {
                    videoHtml = `
                        <h3>Vídeo do Imóvel</h3>
                        <div class="video-container">
                            <iframe src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                        </div>
                    `;
                }
            }

            // HTML do Link Adicional com separação para tela e impressão
            const linkHtml = prop.link ? `
                <div class="additional-link-container">
                    <p class="link-for-screen"><strong>Link Adicional:</strong> <a href="${prop.link}" target="_blank">${prop.link}</a></p>
                    
                    <div class="qr-code-for-print" data-link="${prop.link}">
                        <p><strong>Acesse o Link Adicional:</strong></p>
                        <div id="property-qr-code-container"></div>
                    </div>
                </div>
            ` : '';

            return `
                ${mainImageHtml}
                <h3>${prop.name || ''}</h3>
                <p><strong>Localização:</strong> ${prop.location || ''}</p>
                <p><strong>Valor de Tabela:</strong> ${formatCurrency(prop.listPrice)}</p>
                ${!forClient ? `<p><strong>Valor de Avaliação:</strong> ${formatCurrency(prop.evalPrice)}</p>` : ''}
                ${requiredIncome > 0 ? `<p><strong>Renda Mínima Necessária (Estimada):</strong> ${formatCurrency(requiredIncome)}</p>` : ''}
                <p><strong>Data de Entrega Prevista:</strong> ${formatDate(prop.deliveryDate)}</p>
                ${linkHtml}
                
                <h3>Descrição</h3>
                <p>${(prop.description || 'Nenhuma descrição textual fornecida.').replace(/\n/g, '<br>')}</p>

                ${amenitiesHtml}
                ${videoHtml}
            `;
        };
        
        const generatePDF = (htmlContent, fileName) => {
            const { jsPDF } = window.jspdf;
            const pdfContainer = document.getElementById('pdf-generator');
            pdfContainer.innerHTML = htmlContent;
            
            const contentToRender = pdfContainer.firstElementChild;
            if (!contentToRender) {
                console.error("Conteúdo para PDF não encontrado.");
                return;
            }

            html2canvas(contentToRender, { 
                scale: 2.5,
                useCORS: true, 
                windowWidth: contentToRender.scrollWidth,
                windowHeight: contentToRender.scrollHeight
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                const canvasAspectRatio = canvas.width / canvas.height;
                const imgHeight = pdfWidth / canvasAspectRatio;
                
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                heightLeft -= pdfHeight;

                while (heightLeft > 0) {
                    position = -heightLeft; 
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                    heightLeft -= pdfHeight;
                }

                pdf.save(fileName);
                pdfContainer.innerHTML = '';
            }).catch(err => {
                console.error("Erro ao gerar PDF: ", err);
                alert("Não foi possível gerar o PDF.");
                pdfContainer.innerHTML = '';
            });
        };

        // ==========================================
        // GERAÇÃO DE PORTFÓLIO DE IMÓVEIS
        // ==========================================
        const generateMotivationalText = (prop) => {
            const locations = (prop.location || 'esta excelente localização').split(',');
            const mainLocation = locations[0].trim();

            const templates = [
                `Viva a experiência de morar em ${mainLocation}, uma área privilegiada que combina conveniência e qualidade de vida. Este imóvel é o cenário perfeito para construir novas memórias.`,
                `Imagine-se desfrutando de todo o conforto e sofisticação que este imóvel em ${mainLocation} oferece. Uma oportunidade única para investir no seu bem-estar e garantir um futuro tranquilo para sua família.`,
                `Esta é a sua chance de adquirir um imóvel excepcional em ${mainLocation}. Com uma localização estratégica e uma infraestrutura completa, ele representa não apenas um lar, mas um investimento inteligente.`,
                `Não perca a oportunidade de transformar seu sonho em realidade. Este imóvel em ${mainLocation} foi pensado em cada detalhe para oferecer o máximo de conforto, segurança e lazer.`
            ];
            const index = Math.floor((prop.id || Math.random()) % templates.length);
            return templates[index];
        };

        const generatePortfolioPDF = async (propertyIds) => {
            if (propertyIds.length === 0) return;

            modalSaveBtn.disabled = true;
            modalSaveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfContainer = document.getElementById('pdf-generator');

            for (let i = 0; i < propertyIds.length; i++) {
                const propId = propertyIds[i];
                const prop = db.properties.find(p => p.id == propId);
                if (!prop) continue;

                if (i > 0) pdf.addPage();
                
                const motivationalText = generateMotivationalText(prop);
                const placeholderImg = 'https://via.placeholder.com/800x600.png?text=Sem+Foto';
                
                let images = [];
                if(prop.images && prop.images.length > 0) {
                    const mainIndex = prop.mainImageIndex >= 0 ? prop.mainImageIndex : 0;
                    images.push(prop.images[mainIndex]);
                    prop.images.forEach((img, index) => {
                        if (index !== mainIndex && images.length < 3) images.push(img);
                    });
                }
                while (images.length < 3) images.push(placeholderImg);

                const amenitiesHtml = (prop.amenities && prop.amenities.length > 0)
                    ? prop.amenities.slice(0, 10).map(amenityName => {
                        const amenityData = db.amenities.find(a => a.name === amenityName);
                        const iconClass = amenityData ? amenityData.icon : 'fas fa-check-square';
                        return `<div class="portfolio-v2-amenity-item"><i class="${iconClass}"></i><span>${amenityName}</span></div>`;
                    }).join('')
                    : '<p>Consulte os diferenciais deste empreendimento.</p>';
                
                const pageHtml = `
                    <div class="portfolio-page-v2">
                        <header class="portfolio-v2-header">
                            <div class="portfolio-v2-broker-info">
                                <h1>${db.settings.brokerName}</h1>
                                <p>${db.settings.brokerCreci} | ${db.settings.brokerPhone}</p>
                            </div>
                            <img src="${db.settings.logoUrl}" class="portfolio-v2-logo">
                        </header>
                        <div class="portfolio-v2-title">
                            <h2>${prop.name}</h2>
                            <p>${prop.location}</p>
                        </div>
                        <div class="portfolio-v2-image-gallery">
                            <div class="portfolio-v2-main-image" style="background-image: url('${images[0]}');"></div>
                            <div class="portfolio-v2-secondary-image-1" style="background-image: url('${images[1]}');"></div>
                            <div class="portfolio-v2-secondary-image-2" style="background-image: url('${images[2]}');"></div>
                        </div>
                        <div class="portfolio-v2-content-area">
                            <div class="portfolio-v2-details">
                                <h3>Sobre o Imóvel</h3>
                                <p class="portfolio-v2-description">${(prop.description || 'Descrição não disponível.').replace(/\n/g, '<br>')}</p>
                                <div class="portfolio-v2-key-info">
                                    <p><strong>Valor( a partir):</strong> ${formatCurrency(prop.listPrice)}</p>
                                    <p><strong>Entrega:</strong> ${formatDate(prop.deliveryDate) || 'A definir'}</p>
                                    <p><small>*Valor e disponibilidade sujeitos a alteração sem aviso prévio.</small></p>
                                </div>
                            </div>
                            <div class="portfolio-v2-amenities">
                                <h3>Diferenciais</h3>
                                <div class="portfolio-v2-amenities-list">${amenitiesHtml}</div>
                            </div>
                        </div>
                        <footer class="portfolio-v2-footer">
                            <p class="portfolio-v2-motivational-text">${motivationalText}</p>
                            <span class="portfolio-v2-page-number">${i + 1} / ${propertyIds.length}</span>
                        </footer>
                    </div>
                `;
                pdfContainer.innerHTML = pageHtml;

                try {
                    const canvas = await html2canvas(pdfContainer.querySelector('.portfolio-page-v2'), { scale: 2.5, useCORS: true });
                    const imgData = canvas.toDataURL('image/png');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                } catch(err) {
                    console.error("Erro no html2canvas para o imóvel: ", prop.name, err);
                }
            }

            pdf.save(`Portfolio_Imoveis_${new Date().toISOString().slice(0,10)}.pdf`);
            pdfContainer.innerHTML = '';
            modalSaveBtn.disabled = false;
            closeModal();
        };

        document.getElementById('generate-portfolio-btn').addEventListener('click', () => {
            const selected = [...document.querySelectorAll('.property-checkbox:checked')].map(cb => cb.dataset.id);
            if (selected.length === 0) {
                alert('Selecione pelo menos um imóvel para incluir no portfólio.');
                return;
            }

            let propertyListHtml = '<p>Arraste os imóveis para reordenar como aparecerão no PDF.</p><div id="portfolio-list">';
            selected.forEach(id => {
                const prop = db.properties.find(p => p.id == id);
                if (prop) {
                    propertyListHtml += `
                        <div class="portfolio-item" data-id="${prop.id}" draggable="true">
                            <i class="fas fa-grip-vertical" style="margin-right: 10px; color: #ccc;"></i>
                            <span>${prop.name}</span>
                        </div>`;
                }
            });
            propertyListHtml += '</div>';

            openModal('Gerar Portfólio de Imóveis', propertyListHtml, 'portfolio');

            const portfolioList = document.getElementById('portfolio-list');
            let portfolioDraggedItem = null;

            portfolioList.addEventListener('dragstart', e => {
                portfolioDraggedItem = e.target.closest('.portfolio-item');
                if (portfolioDraggedItem) portfolioDraggedItem.classList.add('dragging');
            });
            portfolioList.addEventListener('dragend', () => {
                if (portfolioDraggedItem) portfolioDraggedItem.classList.remove('dragging');
                portfolioDraggedItem = null;
            });
            portfolioList.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = getDragAfterElement(portfolioList, e.clientY);
                const currentDragging = document.querySelector('.portfolio-item.dragging');
                if (currentDragging) {
                    if (afterElement == null) {
                        portfolioList.appendChild(currentDragging);
                    } else {
                        portfolioList.insertBefore(currentDragging, afterElement);
                    }
                }
            });
        });
        
        // ==========================================
        // GESTÃO DE DOCUMENTOS E RECIBOS
        // ==========================================
        const renderDocumentsTable = () => {
            const tbody = document.querySelector('#documents-table tbody');
            tbody.innerHTML = '';

            const allDocuments = [
                ...db.contracts.map(c => ({...c, docType: 'contract'})),
                ...db.financialRecords.filter(f => f.docType === 'receipt').map(t => ({...t, docType: 'receipt'}))
            ];

            allDocuments.sort((a, b) => new Date(b.date || b.startDate) - new Date(a.date || a.startDate));

            if (allDocuments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">Nenhum documento gerado.</td></tr>';
                return;
            }

            allDocuments.forEach(doc => {
                let typeStr = 'N/A', clientStr = 'N/A', propertyStr = 'N/A', valueStr = '-', dateStr = '';

                if (doc.docType === 'contract') {
                    dateStr = formatDate(doc.date);
                    const property = db.properties.find(p => p.id == doc.propertyId);
                    propertyStr = property ? property.name : 'N/A';
                    
                    switch(doc.type) {
                        case 'service_sale': 
                            typeStr = 'Serviço de Venda';
                            const owner = db.clients.find(c => c.id == doc.ownerId);
                            clientStr = `Proprietário: ${owner ? owner.name : 'N/A'}`;
                            valueStr = `${doc.commissionRate}%`;
                            break;
                        case 'service_rental':
                            typeStr = 'Serviço de Locação';
                            const ownerR = db.clients.find(c => c.id == doc.ownerId);
                            clientStr = `Proprietário: ${ownerR ? ownerR.name : 'N/A'}`;
                             valueStr = `${doc.commissionRate}%`;
                            break;
                        case 'lease':
                            typeStr = 'Contrato de Locação';
                            const tenant = db.clients.find(c => c.id == doc.tenantId);
                            const landlord = db.clients.find(c => c.id == doc.ownerId);
                            clientStr = `Locador: ${landlord ? landlord.name : 'N/A'} <br> Locatário: ${tenant ? tenant.name : 'N/A'}`;
                            valueStr = formatCurrency(doc.value);
                            break;
                    }
                } else { // receipt
                    dateStr = formatDate(doc.startDate);
                    typeStr = 'Recibo';
                    const client = db.clients.find(c => c.id == doc.clientId);
                    clientStr = client ? client.name : 'N/A';
                    valueStr = formatCurrency(doc.value);
                }

                tbody.innerHTML += `
                    <tr>
                        <td>${typeStr}</td>
                        <td>${clientStr}</td>
                        <td>${propertyStr}</td>
                        <td>${valueStr}</td>
                        <td>${dateStr}</td>
                        <td class="action-buttons">
                            <button title="Gerar PDF novamente" data-action="reprint" data-id="${doc.id}" data-type="${doc.docType}"><i class="fas fa-file-pdf"></i></button>
                            <button title="Excluir" data-action="delete" data-id="${doc.id}" data-type="${doc.docType}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        };

        const getContractFormHtml = () => {
            const clientOptions = db.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            const propertyOptions = db.properties.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            const today = new Date().toISOString().slice(0, 10);
            return `
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="contract-type">Tipo de Contrato</label>
                        <select id="contract-type">
                            <option value="">Selecione...</option>
                            <option value="service_sale">Prestação de Serviço de Venda</option>
                            <option value="service_rental">Prestação de Serviço de Locação</option>
                            <option value="lease">Contrato de Locação de Imóvel</option>
                        </select>
                    </div>
                    
                    <div id="service-fields" class="form-group full-width hidden-field">
                        <div class="form-grid">
                            <div class="form-group"><label for="contract-owner-id">Proprietário (Contratante)</label><select id="contract-owner-id">${clientOptions}</select></div>
                            <div class="form-group"><label for="contract-property-id">Imóvel</label><select id="contract-property-id">${propertyOptions}</select></div>
                            <div class="form-group"><label for="contract-commission-rate">Comissão (%)</label><input type="number" id="contract-commission-rate" value="${db.settings.defaultCommission}"></div>
                            <div class="form-group"><label for="contract-duration">Prazo do Contrato (meses)</label><input type="number" id="contract-duration" value="6"></div>
                            <div class="form-group"><label for="contract-exclusivity">
                                <input type="checkbox" id="contract-exclusivity" checked> Com Cláusula de Exclusividade
                            </label></div>
                        </div>
                    </div>

                    <div id="lease-fields" class="form-group full-width hidden-field">
                         <div class="form-grid">
                            <div class="form-group"><label for="lease-owner-id">Locador (Proprietário)</label><select id="lease-owner-id">${clientOptions}</select></div>
                            <div class="form-group"><label for="lease-tenant-id">Locatário (Inquilino)</label><select id="lease-tenant-id">${clientOptions}</select></div>
                            <div class="form-group"><label for="lease-property-id">Imóvel</label><select id="lease-property-id">${propertyOptions}</select></div>
                            <div class="form-group"><label for="lease-value">Valor do Aluguel (R$)</label><input type="number" id="lease-value"></div>
                            <div class="form-group"><label for="lease-duration">Prazo do Contrato (meses)</label><input type="number" id="lease-duration" value="30"></div>
                             <div class="form-group"><label for="lease-start-date">Data de Início</label><input type="date" id="lease-start-date" value="${today}"></div>
                        </div>
                    </div>
                </div>
            `;
        };
        
        const getReceiptFormHtml = () => {
             const clientOptions = db.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
             const today = new Date().toISOString().slice(0, 10);
             return `
                <div class="form-grid">
                    <div class="form-group"><label for="receipt-client-id">Recebido de (Cliente)</label><select id="receipt-client-id"><option value="">Selecione...</option>${clientOptions}</select></div>
                    <div class="form-group"><label for="receipt-value">Valor (R$)</label><input type="number" id="receipt-value"></div>
                    <div class="form-group"><label for="receipt-date">Data do Pagamento</label><input type="date" id="receipt-date" value="${today}"></div>
                    <div class="form-group full-width"><label for="receipt-description">Referente a</label><textarea id="receipt-description" placeholder="Ex: Pagamento de comissão pela venda do imóvel X"></textarea></div>
                </div>
            `;
        };
        
        document.getElementById('add-contract-btn').addEventListener('click', () => {
            openModal('Gerar Novo Contrato', getContractFormHtml(), 'contract');
            document.getElementById('contract-type').addEventListener('change', e => {
                const type = e.target.value;
                document.getElementById('service-fields').style.display = (type === 'service_sale' || type === 'service_rental') ? 'block' : 'none';
                document.getElementById('lease-fields').style.display = type === 'lease' ? 'block' : 'none';
            });
        });

        document.getElementById('add-receipt-btn').addEventListener('click', () => {
            openModal('Gerar Novo Recibo', getReceiptFormHtml(), 'receipt');
        });

        document.querySelector('#documents-table tbody').addEventListener('click', e => {
            const button = e.target.closest('button');
            if (!button) return;
            const id = button.dataset.id;
            const type = button.dataset.type;
            const action = button.dataset.action;

            if (action === 'delete') {
                if (confirm('Tem certeza que deseja excluir este documento? Esta ação não pode ser desfeita.')) {
                    if (type === 'contract') {
                        db.contracts = db.contracts.filter(c => c.id != id);
                    } else {
                        db.financialRecords = db.financialRecords.filter(t => t.id != id);
                    }
                    saveData();
                    renderDocumentsTable();
                }
            } else if (action === 'reprint') {
                let doc;
                if (type === 'contract') {
                    doc = db.contracts.find(c => c.id == id);
                } else {
                    doc = db.financialRecords.find(t => t.id == id);
                }
                generateDocumentPdf(doc);
            }
        });
        
        // ==========================================
        // INÍCIO: GESTÃO DE RELATÓRIOS DE PLANTÃO
        // ==========================================
        const getDutyReportFormHtml = (report = {}) => {
            const today = new Date().toISOString().slice(0, 10);
            let clientsHtml = '';
            if (report.attendedClients && report.attendedClients.length > 0) {
                report.attendedClients.forEach(client => {
                    clientsHtml += getAttendedClientRowHtml(client);
                });
            } else {
                clientsHtml = getAttendedClientRowHtml(); // Adiciona uma linha em branco para começar
            }

            return `
                <div class="form-grid">
                    <div class="form-group"><label for="duty-date">Data do Plantão</label><input type="date" id="duty-date" value="${report.date || today}"></div>
                    <div class="form-group"><label for="duty-location">Local do Plantão</label><input type="text" id="duty-location" value="${report.location || ''}"></div>
                </div>
                <hr style="margin: 1.5rem 0;">
                <h3>Clientes Atendidos</h3>
                <div id="attended-clients-list">${clientsHtml}</div>
                <button type="button" id="add-attended-client-btn" class="btn-secondary"><i class="fas fa-plus"></i> Adicionar Cliente</button>
            `;
        };

        const getAttendedClientRowHtml = (client = {}) => {
            const funnelOptions = db.funnelStages.map(stage => 
                `<option value="${stage.id}" ${client.stageId == stage.id ? 'selected' : ''}>${stage.name}</option>`
            ).join('');
            
            return `
                <div class="attended-client-item">
                    <div class="form-group">
                        <input type="text" class="attended-client-name" placeholder="Nome do Cliente" value="${client.name || ''}">
                    </div>
                     <div class="form-group">
                        <select class="attended-client-stage">${funnelOptions}</select>
                    </div>
                    <div class="form-group">
                        <input type="text" class="attended-client-details" placeholder="Detalhes do atendimento" value="${client.details || ''}">
                    </div>
                    <button type="button" class="btn-danger remove-attended-client-btn"><i class="fas fa-trash"></i></button>
                </div>
            `;
        };
        
        const addAttendedClientRow = () => {
            const list = document.getElementById('attended-clients-list');
            list.insertAdjacentHTML('beforeend', getAttendedClientRowHtml());
        };

        const handleAttendedClientActions = (e) => {
            if (e.target.closest('.remove-attended-client-btn')) {
                e.target.closest('.attended-client-item').remove();
            }
        };

        document.getElementById('add-duty-report-btn').addEventListener('click', () => {
            openModal('Novo Relatório de Plantão', getDutyReportFormHtml(), 'dutyReport');
        });

        const renderDutyReportsTable = () => {
            const tbody = document.querySelector('#duty-reports-table tbody');
            tbody.innerHTML = '';

            const sortedReports = [...db.dutyReports].sort((a,b) => new Date(b.date) - new Date(a.date));

            if (sortedReports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">Nenhum relatório de plantão encontrado.</td></tr>';
                return;
            }

            sortedReports.forEach(report => {
                tbody.innerHTML += `
                    <tr>
                        <td>${formatDate(report.date)}</td>
                        <td>${report.location}</td>
                        <td>${report.attendedClients?.length || 0}</td>
                        <td class="action-buttons">
                            <button title="Gerar PDF" data-action="pdf" data-id="${report.id}"><i class="fas fa-file-pdf"></i></button>
                            <button title="Editar" data-action="edit" data-id="${report.id}"><i class="fas fa-edit"></i></button>
                            <button title="Excluir" data-action="delete" data-id="${report.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        };
        
        document.querySelector('#duty-reports-table tbody').addEventListener('click', e => {
            const button = e.target.closest('button');
            if (!button) return;
            const id = button.dataset.id;
            const action = button.dataset.action;

            if (action === 'edit') {
                const report = db.dutyReports.find(r => r.id == id);
                openModal('Editar Relatório de Plantão', getDutyReportFormHtml(report), 'dutyReport', id);
            } else if (action === 'delete') {
                if (confirm('Deseja realmente excluir este relatório?')) {
                    db.dutyReports = db.dutyReports.filter(r => r.id != id);
                    saveData();
                    renderDutyReportsTable();
                }
            } else if (action === 'pdf') {
                generateDutyReportPDF(id);
            }
        });

        const getDutyReportPDFTemplate = (report) => {
            let clientsTableHtml = `
                <table class="pdf-duty-report-table">
                    <thead>
                        <tr>
                            <th>Cliente Atendido</th>
                            <th>Etapa do Funil</th>
                            <th>Detalhes / Tratativa</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            report.attendedClients.forEach(client => {
                const stage = db.funnelStages.find(s => s.id == client.stageId);
                clientsTableHtml += `
                    <tr>
                        <td>${client.name}</td>
                        <td>${stage ? stage.name : 'N/A'}</td>
                        <td>${client.details}</td>
                    </tr>
                `;
            });

            clientsTableHtml += '</tbody></table>';

            return `
                <div class="pdf-document-container">
                    ${getDocumentHeaderHtml()}
                    <div class="pdf-content">
                        <h1>Relatório de Plantão</h1>
                        <p><strong>Data:</strong> ${formatDate(report.date)}</p>
                        <p><strong>Local:</strong> ${report.location}</p>
                        
                        <h2>Resumo dos Atendimentos</h2>
                        ${clientsTableHtml}

                        <br><br>
                        <p class="pdf-centered-text">Relatório gerado em ${new Date().toLocaleDateString('pt-BR')}.</p>
                         <div class="pdf-signatures">
                            <div class="pdf-signature-line">
                                ${db.settings.brokerName}<br>
                                ${db.settings.brokerCreci}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const generateDutyReportPDF = (id) => {
            const report = db.dutyReports.find(r => r.id == id);
            if (!report) return;
            const html = getDutyReportPDFTemplate(report);
            const filename = `Relatorio_Plantao_${report.date}.pdf`;
            generatePDF(html, filename);
        };
        
        // ==========================================
        // INÍCIO: GESTÃO DA Informes e Notas (COM FOTOS E VÍDEOS)
        // ==========================================
        const getKnowledgeBaseFormHtml = (info = {}) => {
            tempNoteImages = info.images ? [...info.images] : [];
            const videoLinksText = (info.videos || []).map(url => {
                if (url.includes('youtube.com/embed/')) {
                    const videoId = url.split('embed/')[1];
                    return `https://www.youtube.com/watch?v=${videoId}`;
                }
                if (url.includes('player.vimeo.com/video/')) {
                    const videoId = url.split('video/')[1];
                    return `https://vimeo.com/${videoId}`;
                }
                return url;
            }).join('\n');

            return `
                <div class="form-group full-width">
                    <label for="info-title">Título</label>
                    <input type="text" id="info-title" value="${info.title || ''}" placeholder="Ex: Processo de Financiamento Caixa">
                </div>
                <div class="form-group full-width">
                    <label for="info-content">Conteúdo</label>
                    <textarea id="info-content" rows="8" placeholder="Digite ou cole a informação aqui...">${info.content || ''}</textarea>
                </div>
                <div class="form-group full-width">
                    <label for="note-images">Imagens</label>
                    <input type="file" id="note-images" multiple accept="image/*">
                    <div id="note-image-previews"></div>
                </div>
                 <div class="form-group full-width">
                    <label for="info-videos">Links de Vídeo (YouTube/Vimeo, um por linha)</label>
                    <textarea id="info-videos" rows="4" placeholder="https://www.youtube.com/watch?v=...\nhttps://vimeo.com/...">${videoLinksText}</textarea>
                </div>
            `;
        };
        
        const renderKnowledgeBase = (filter = '') => {
            const container = document.getElementById('info-cards-container');
            container.innerHTML = '';
            
            const lowerFilter = filter.toLowerCase();
            const filteredInfo = db.knowledgeBase.filter(info =>
                (info.title || '').toLowerCase().includes(lowerFilter) ||
                (info.content || '').toLowerCase().includes(lowerFilter)
            );

            if (filteredInfo.length === 0) {
                container.innerHTML = '<p>Nenhuma informação encontrada. Clique em "Nova Informação" para adicionar.</p>';
                return;
            }

            filteredInfo.forEach(info => {
                const card = document.createElement('div');
                card.className = 'info-card';
                
                const hasImage = info.images && info.images.length > 0;
                const thumbHtml = hasImage ? `<img src="${info.images[0]}" alt="Thumbnail" class="info-card-thumb">` : '';

                card.innerHTML = `
                    <div class="info-card-header">
                        ${thumbHtml}
                        <div class="info-card-title-section">
                            <h3>${info.title}</h3>
                        </div>
                    </div>
                    <div class="info-card-content">${info.content.replace(/\n/g, '<br>')}</div>
                    <div class="info-card-footer">
                        <button title="Visualizar" data-action="view" data-id="${info.id}"><i class="fas fa-eye"></i> Visualizar</button>
                        <button title="Editar" data-action="edit" data-id="${info.id}"><i class="fas fa-edit"></i> Editar</button>
                        <button title="Excluir" data-action="delete" data-id="${info.id}"><i class="fas fa-trash"></i> Excluir</button>
                    </div>
                `;
                container.appendChild(card);
            });
        };

        document.getElementById('add-info-btn').addEventListener('click', () => {
            openModal('Adicionar Nova Informação', getKnowledgeBaseFormHtml(), 'knowledgeBase');
            renderNoteImagePreviews();
        });
        
        document.getElementById('info-search').addEventListener('input', e => {
            renderKnowledgeBase(e.target.value);
        });

        document.getElementById('info-cards-container').addEventListener('click', e => {
            const button = e.target.closest('button');
            if (!button) return;
            
            const id = button.dataset.id;
            const action = button.dataset.action;
            const info = db.knowledgeBase.find(i => i.id == id);

            if (action === 'edit') {
                openModal('Editar Informação', getKnowledgeBaseFormHtml(info), 'knowledgeBase', id);
                renderNoteImagePreviews();
            } else if (action === 'delete') {
                if (confirm('Deseja realmente excluir esta informação?')) {
                    db.knowledgeBase = db.knowledgeBase.filter(i => i.id != id);
                    saveData();
                    renderKnowledgeBase(document.getElementById('info-search').value);
                }
            } else if (action === 'view') {
                 if (info) {
                    let imagesHtml = '';
                    if (info.images && info.images.length > 0) {
                        imagesHtml = `<h3>Imagens</h3><div class="view-note-gallery" data-note-id="${info.id}">${info.images.map((img, index) => `<img src="${img}" alt="Imagem da nota" data-index="${index}" class="note-gallery-img">`).join('')}</div>`;
                    }
                    
                    let videosHtml = '';
                    if (info.videos && info.videos.length > 0) {
                        videosHtml = `<h3>Vídeos</h3>${info.videos.map(videoUrl => `
                            <div class="video-container" style="margin-bottom: 1rem;">
                                <iframe src="${videoUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                            </div>
                        `).join('')}`;
                    }
                    
                    const viewHtml = `
                        <div class="record-details">
                            <p>${info.content.replace(/\n/g, '<br>')}</p>
                            ${imagesHtml}
                            ${videosHtml}
                        </div>`;
                    openModal(info.title, viewHtml, 'view', null, false);
                 }
            }
        });

        // ==========================================
        // NOVAS FUNÇÕES PARA MANIPULAÇÃO DE IMAGENS DE NOTAS
        // ==========================================
        const renderNoteImagePreviews = () => {
            const container = document.getElementById('note-image-previews');
            if (!container) return;
            container.innerHTML = tempNoteImages.map((imgData, index) => `
                <div class="img-preview-container">
                    <img src="${imgData}" alt="Pré-visualização ${index + 1}">
                    <button class="remove-img-btn" data-index="${index}">&times;</button>
                </div>
            `).join('');
        };
        
        const handleNoteImageSelection = (event) => {
            const files = event.target.files;
            if (!files) return;

            const imagePromises = [];
            for (let i = 0; i < files.length; i++) {
                imagePromises.push(new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 800;
                            const scaleSize = (img.width > MAX_WIDTH) ? MAX_WIDTH / img.width : 1;
                            canvas.width = img.width * scaleSize;
                            canvas.height = img.height * scaleSize;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            resolve(canvas.toDataURL('image/jpeg', 0.7));
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(files[i]);
                }));
            }

            Promise.all(imagePromises).then(images => {
                tempNoteImages.push(...images);
                renderNoteImagePreviews();
            }).catch(error => {
                console.error("Erro ao processar imagens da nota:", error);
                alert("Ocorreu um erro ao carregar as imagens.");
            });
        };

        const handleNoteImagePreviewActions = (event) => {
            if (event.target.classList.contains('remove-img-btn')) {
                const index = parseInt(event.target.dataset.index, 10);
                tempNoteImages.splice(index, 1);
                renderNoteImagePreviews();
            }
        };

        // ==========================================
        // LÓGICA DE SALVAMENTO DO MODAL (ATUALIZADA)
        // ==========================================
        modalSaveBtn.addEventListener('click', async () => {
            if (currentEntityType === 'client') {
                // 1. Coletamos os dados do formulário
                const clientData = {
                    id: currentEditingId || Date.now() + Math.random(), name: document.getElementById('client-name').value, phone: document.getElementById('client-phone').value,
                    email: document.getElementById('client-email').value, cpf: document.getElementById('client-cpf').value, birthdate: document.getElementById('client-birthdate').value,
                    income: parseFloat(document.getElementById('client-income').value) || 0, propertyValue: parseFloat(document.getElementById('client-property-value').value) || 0,
                    commission: parseFloat(document.getElementById('client-commission').value) || null, stageId: parseInt(document.getElementById('client-stageId').value),
                    leadSource: document.getElementById('client-lead-source').value, propertyId: document.getElementById('client-propertyId').value, notes: document.getElementById('client-notes').value,
                    lastContact: currentEditingId ? db.clients.find(c=>c.id==currentEditingId).lastContact : null
                };

                // 2. Padronizamos os dados de verificação (telefone e CPF), removendo letras e símbolos
                const newPhone = (clientData.phone || '').replace(/\D/g, '');
                const newCpf = (clientData.cpf || '').replace(/\D/g, '');

                if(currentEditingId) {
                    // 3. Se estiver EDITANDO, apenas salve (lógica original)
                    const index = db.clients.findIndex(c => c.id == currentEditingId);
                    if (index > -1) db.clients[index] = clientData;
                } else {
                    // 4. Se estiver ADICIONANDO UM NOVO CLIENTE, fazemos a verificação
                    let existingClient = null;

                    // Tenta encontrar por telefone (se o telefone foi preenchido)
                    if (newPhone.length > 0) {
                        existingClient = db.clients.find(c => (c.phone || '').replace(/\D/g, '') === newPhone);
                    }

                    // Se não achou por telefone, tenta por CPF (se o CPF foi preenchido)
                    if (!existingClient && newCpf.length > 0) {
                        existingClient = db.clients.find(c => (c.cpf || '').replace(/\D/g, '') === newCpf);
                    }

                    // 5. Verificamos o resultado
                    if (existingClient) {
                        // DUPLICADO! Mostra o alerta e PARA o salvamento
                        openAlertModal('Cliente Duplicado', 
                            `<p><i class="fas fa-exclamation-triangle" style="color: var(--warning-color);"></i> Um cliente já está cadastrado com este telefone ou CPF.</p>
                             <p style="margin-top: 10px;"><strong>Nome:</strong> ${existingClient.name}<br>
                             <strong>Telefone:</strong> ${existingClient.phone || 'N/A'}</p>`
                        );
                        return; // Impede que o restante do código de salvar seja executado
                    } else {
                        // NÃO DUPLICADO! Adiciona o cliente (lógica original)
                        db.clients.push(clientData);
                    }
                }
            }
            if (currentEntityType === 'property') {
                const selectedAmenities = Array.from(document.querySelectorAll('input[name="amenities"]:checked')).map(cb => cb.value);
                const propData = {
                    id: currentEditingId || Date.now() + Math.random(), name: document.getElementById('prop-name').value, location: document.getElementById('prop-location').value,
                    listPrice: parseFloat(document.getElementById('prop-list-price').value) || 0, evalPrice: parseFloat(document.getElementById('prop-eval-price').value) || 0,
                    deliveryDate: document.getElementById('prop-delivery-date').value, link: document.getElementById('prop-link').value, 
                    videoLink: document.getElementById('prop-video-link').value, description: document.getElementById('prop-description').value,
                    images: tempPropertyImages, mainImageIndex: tempMainImageIndex, amenities: selectedAmenities
                };
                 if(currentEditingId) {
                    const index = db.properties.findIndex(p => p.id == currentEditingId);
                    if (index > -1) db.properties[index] = propData;
                } else { db.properties.push(propData); }
            }
            if (currentEntityType === 'event') {
                const eventData = {
                    id: currentEditingId || Date.now() + Math.random(), title: document.getElementById('event-title').value,
                    clientId: document.getElementById('event-client').value, date: document.getElementById('event-date').value, time: document.getElementById('event-time').value,
                    description: document.getElementById('event-description').value, recurrence: document.getElementById('event-recurrence').value,
                    endDate: document.getElementById('event-end-date').value, completed: currentEditingId ? db.events.find(e=>e.id==currentEditingId).completed : false,
                };
                 if(currentEditingId) {
                    const index = db.events.findIndex(e => e.id == currentEditingId);
                     if (index > -1) db.events[index] = eventData;
                } else { db.events.push(eventData); }
            }
            if (currentEntityType === 'link') {
                const linkData = { id: currentEditingId || Date.now() + Math.random(), title: document.getElementById('link-title').value, url: document.getElementById('link-url').value };
                if(currentEditingId) {
                    const index = db.usefulLinks.findIndex(l => l.id == currentEditingId);
                    if (index > -1) db.usefulLinks[index] = linkData;
                } else { db.usefulLinks.push(linkData); }
            }
            if (currentEntityType === 'portfolio') {
                const orderedIds = [...document.querySelectorAll('#portfolio-list .portfolio-item')].map(item => item.dataset.id);
                generatePortfolioPDF(orderedIds);
                return;
            }
            if (currentEntityType === 'contract') {
                const type = document.getElementById('contract-type').value;
                if (!type) { alert('Selecione um tipo de contrato.'); return; }
                let newContract = { id: Date.now() + Math.random(), docType: 'contract', date: new Date().toISOString().slice(0, 10), type: type };
                if (type === 'service_sale' || type === 'service_rental') {
                    newContract.ownerId = document.getElementById('contract-owner-id').value; newContract.propertyId = document.getElementById('contract-property-id').value;
                    newContract.commissionRate = parseFloat(document.getElementById('contract-commission-rate').value); newContract.duration = parseInt(document.getElementById('contract-duration').value);
                    newContract.exclusivity = document.getElementById('contract-exclusivity').checked;
                } else if (type === 'lease') {
                    newContract.ownerId = document.getElementById('lease-owner-id').value; newContract.tenantId = document.getElementById('lease-tenant-id').value;
                    newContract.propertyId = document.getElementById('lease-property-id').value; newContract.value = parseFloat(document.getElementById('lease-value').value);
                    newContract.duration = parseInt(document.getElementById('lease-duration').value); newContract.startDate = document.getElementById('lease-start-date').value;
                }
                db.contracts.push(newContract);
                generateDocumentPdf(newContract);
            }
            if (currentEntityType === 'receipt') {
                const receipt = {
                    id: Date.now() + Math.random(), docType: 'receipt', clientId: document.getElementById('receipt-client-id').value,
                    value: parseFloat(document.getElementById('receipt-value').value), startDate: document.getElementById('receipt-date').value,
                    description: document.getElementById('receipt-description').value, type: 'income', category: 'Recibo', recurrence: 'none', totalInstallments: 1
                };
                 receipt.payments = generatePaymentsArray(receipt);
                if (!receipt.clientId || !receipt.value) { alert('Preencha o cliente e o valor.'); return; }
                db.financialRecords.push(receipt);
                generateDocumentPdf(receipt);
            }
             
            if (currentEntityType === 'financialRecord') {
                // AQUI ESTÁ A ÚNICA LINHA QUE VOCÊ PRECISA MUDAR
                const isEditing = typeof currentEditingId === 'number';

                let existingRecord = isEditing ? db.financialRecords.find(r => r.id == currentEditingId) : {};

                const recordData = {
                    ...existingRecord,
                    id: isEditing ? currentEditingId : Date.now() + Math.random(),
                    description: document.getElementById('fin-description').value,
                    value: parseFloat(document.getElementById('fin-value').value) || 0,
                    category: document.getElementById('fin-category').value,
                    startDate: document.getElementById('fin-start-date').value,
                    recurrence: document.getElementById('fin-recurrence').value,
                    totalInstallments: parseInt(document.getElementById('fin-installments').value) || 1,
                    type: isEditing ? existingRecord.type : currentEditingId,
                };
                
                const needsPaymentUpdate = !isEditing || 
                                           recordData.startDate !== existingRecord.startDate ||
                                           recordData.totalInstallments !== existingRecord.totalInstallments ||
                                           recordData.recurrence !== existingRecord.recurrence;

                if (needsPaymentUpdate) {
                     recordData.payments = generatePaymentsArray(recordData);
                }

                if (isEditing) {
                    const index = db.financialRecords.findIndex(r => r.id == currentEditingId);
                    if (index > -1) db.financialRecords[index] = recordData;
                } else {
                    db.financialRecords.push(recordData);
                }
            }
            if (currentEntityType === 'dutyReport') {
                const attendedClients = [];
                document.querySelectorAll('.attended-client-item').forEach(item => {
                    const name = item.querySelector('.attended-client-name').value.trim();
                    if (name) {
                        attendedClients.push({
                            name: name,
                            stageId: parseInt(item.querySelector('.attended-client-stage').value),
                            details: item.querySelector('.attended-client-details').value.trim()
                        });
                    }
                });

                const reportData = {
                    id: currentEditingId || Date.now() + Math.random(),
                    date: document.getElementById('duty-date').value,
                    location: document.getElementById('duty-location').value.trim(),
                    attendedClients: attendedClients
                };

                if (currentEditingId) {
                    const index = db.dutyReports.findIndex(r => r.id == currentEditingId);
                    if (index > -1) db.dutyReports[index] = reportData;
                } else {
                    db.dutyReports.push(reportData);
                }
            }
            if (currentEntityType === 'knowledgeBase') {
                const videoLinks = document.getElementById('info-videos').value.trim().split('\n')
                                         .map(url => getEmbedUrl(url.trim()))
                                         .filter(url => url);

                const infoData = {
                    id: currentEditingId || Date.now() + Math.random(),
                    title: document.getElementById('info-title').value.trim(),
                    content: document.getElementById('info-content').value.trim(),
                    images: tempNoteImages,
                    videos: videoLinks
                };
                if (!infoData.title) { alert('O título é obrigatório.'); return; }

                if (currentEditingId) {
                    const index = db.knowledgeBase.findIndex(i => i.id == currentEditingId);
                    if (index > -1) db.knowledgeBase[index] = infoData;
                } else {
                    db.knowledgeBase.push(infoData);
                }
            }

            await saveData();
            closeModal();
            const activePanelId = document.querySelector('.panel.active')?.id.replace('panel-', '');
            if(activePanelId) switchPanel(activePanelId);
        });


        // ==========================================
        // DASHBOARD (COM ALERTAS FINANCEIROS)
        // ==========================================
        const getFinancialAlerts = (days = 7) => {
            const alerts = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            const limitDate = new Date();
            limitDate.setDate(today.getDate() + days);

            db.financialRecords.forEach(record => {
                record.payments.forEach(payment => {
                    if (payment.status === 'pending') {
                        const paymentDate = new Date(payment.date + 'T00:00:00');
                        if (paymentDate <= limitDate) {
                            alerts.push({
                                recordId: record.id,
                                paymentDate: payment.date,
                                description: record.description,
                                value: record.value,
                                type: record.type,
                                isOverdue: paymentDate < today
                            });
                        }
                    }
                });
            });
            return alerts.sort((a, b) => new Date(a.paymentDate) - new Date(b.paymentDate));
        };
        
        const renderDashboard = () => {
            const container = document.getElementById('dashboard-content');
            
            const leadsThisMonth = db.clients.length;
            const leadsGoal = db.settings.goals.leads || 1;
            
            const funnelSummary = db.funnelStages.map(stage => {
                const count = db.clients.filter(c => c.stageId === stage.id).length;
                return `<li>${stage.name}: <strong>${count}</strong></li>`;
            }).join('');

            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);

            const todayEvents = getEventsForDate(today);
            const tomorrowEvents = getEventsForDate(tomorrow);

            const renderEventList = (events) => {
                if (events.length === 0) return '<li>Nenhum compromisso.</li>';
                return events.map(e => {
                     if (e.type !== 'event') return `<li><i class="fas fa-dollar-sign"></i> ${e.title}</li>`;
                     const status = e.completed ? '<span class="status-realizado"> (Realizado)</span>' : '';
                     return `<li class="dashboard-event-item" data-event-id="${e.id}">${e.title}${status}</li>`;
                }).join('');
            };

            const financialAlerts = getFinancialAlerts();
            const staleClients = getStaleClientsForArchiving();
            let financialAlertsHtml = '<li>Nenhum lançamento próximo.</li>';
            if (financialAlerts.length > 0) {
                financialAlertsHtml = financialAlerts.map(alert => {
                    const icon = alert.type === 'income' ? 'fa-arrow-up' : 'fa-arrow-down';
                    const color = alert.type === 'income' ? 'var(--success-color)' : 'var(--danger-color)';
                    const overdueClass = alert.isOverdue ? 'overdue' : '';
                    return `
                        <li class="financial-alert-item ${overdueClass}" data-record-id="${alert.recordId}" data-payment-date="${alert.paymentDate}">
                            <i class="fas ${icon}" style="color: ${color};"></i> ${alert.description}
                            <span class="alert-details">${formatCurrency(alert.value)} - Vence em: ${formatDate(alert.paymentDate)}</span>
                        </li>
                    `;
                }).join('');
            }

            container.innerHTML = `
    <div class="dashboard-card">
        <h3>Meta de Leads do Mês</h3>
        <p>${leadsThisMonth} / ${leadsGoal} Leads</p>
        <progress value="${leadsThisMonth}" max="${leadsGoal}" style="width: 100%; height: 20px;"></progress>
    </div>

    <div class="dashboard-card">
        <h3>Sugestão de Arquivamento</h3>
        <p style="font-size: 0.9rem; opacity: 0.8;">Clientes com 3+ contatos sem evolução no funil.</p>
        <ul style="max-height: 150px; overflow-y: auto;">
            ${staleClients.length > 0 ? 
                staleClients.map(client => `
                    <li style="cursor: pointer; color: var(--danger-color);" 
                        onclick="switchPanel('clients'); document.getElementById('client-search').value='${client.name}'; triggerClientTableRender();"
                        title="Clique para localizar ${client.name}">
                        <i class="fas fa-archive"></i> ${client.name}
                    </li>`).join('') : 
                '<li>Nenhum cliente estagnado.</li>'
            }
        </ul>
    </div>
    <div class="dashboard-card">
        <h3>Lançamentos Vencendo e Vencidos</h3>
        <ul>${financialAlertsHtml}</ul>
    </div>
    <div class="dashboard-card">
        <h3>Eventos de Hoje</h3>
        <ul>${renderEventList(todayEvents)}</ul>
    </div>
        <div class="dashboard-card">
        <h3>Eventos de Amanhã</h3>
        <ul>${renderEventList(tomorrowEvents)}</ul>
    </div>
`;
            
            renderFunnelChart();
        };

        document.getElementById('dashboard-content').addEventListener('click', e => {
            const eventItem = e.target.closest('.dashboard-event-item');
            if (eventItem) {
                const eventId = eventItem.dataset.eventId;
                const event = db.events.find(ev => ev.id == eventId);
                if (event) {
                    openModal('Editar Compromisso', getEventFormHtml(event, event.date), 'event', event.id);
                }
                return;
            }

            const financialAlertItem = e.target.closest('.financial-alert-item');
            if (financialAlertItem) {
                const recordId = financialAlertItem.dataset.recordId;
                const paymentDate = financialAlertItem.dataset.paymentDate;
                const record = db.financialRecords.find(r => r.id == recordId);
                if (record) {
                    currentPaymentDateToConfirm = paymentDate; 
                    openModal('Confirmar ou Editar Lançamento', getFinancialRecordFormHtml(record, record.type, paymentDate), 'financialRecord', record.id);
                }
            }
        });
        
        const confirmPayment = async () => {
            if (!currentEditingId || !currentPaymentDateToConfirm) return;

            const record = db.financialRecords.find(r => r.id == currentEditingId);
            if (!record) return;

            const payment = record.payments.find(p => p.date === currentPaymentDateToConfirm);
            if (payment) {
                payment.status = 'paid';
                await saveData();
                alert('Pagamento confirmado com sucesso!');
                closeModal();
                renderDashboard();
                renderFinancialBI();
            }
        };

        modalBody.addEventListener('click', e => {
            const galleryImg = e.target.closest('.note-gallery-img');
            if (galleryImg) {
                const noteId = galleryImg.closest('.view-note-gallery').dataset.noteId;
                const startIndex = parseInt(galleryImg.dataset.index, 10);
                openImageGallery({ entity: 'note', id: noteId, startIndex: startIndex });
            }
        });

        
        const renderFunnelChart = () => {
            const container = document.getElementById('funnel-chart');
            container.innerHTML = '';
            const funnelColors = ['#2C3E50', '#34495E', '#7F8C8D', '#BDC3C7', '#D4AF37'];

            const funnelData = db.funnelStages.map(stage => ({
                name: stage.name,
                count: db.clients.filter(c => c.stageId === stage.id).length
            }));

            const maxCount = Math.max(...funnelData.map(d => d.count), 1);

            funnelData.forEach((stage, index) => {
                const heightPercentage = (stage.count / maxCount) * 100;
                const color = funnelColors[index % funnelColors.length];
                container.innerHTML += `
                    <div class="funnel-bar-wrapper">
                        <div class="funnel-bar" style="height: ${heightPercentage}%; background: ${color};">
                            <span class="funnel-bar-label">${stage.count}</span>
                        </div>
                        <div class="funnel-stage-name">${stage.name}</div>
                    </div>
                `;
            });
        };
        
        // ==========================================
        // FUNÇÕES DE EXPORTAÇÃO
        // ==========================================
        document.getElementById('export-clients-excel').addEventListener('click', () => {
            const searchValue = document.getElementById('client-search').value;
            const stageValue = document.querySelector('.funnel-filter-btn.active')?.dataset.stageId;
            const sourceValue = document.getElementById('client-source-filter').value;

            let filteredClients = db.clients.filter(c => 
                (c.name || '').toLowerCase().includes(searchValue.toLowerCase()) || 
                (c.phone || '').includes(searchValue) || 
                (c.cpf || '').includes(searchValue)
            );
            if (stageValue && stageValue !== 'all') filteredClients = filteredClients.filter(c => c.stageId == stageValue);
            if (sourceValue && sourceValue !== 'all') filteredClients = filteredClients.filter(c => c.leadSource === sourceValue);

            const dataToExport = filteredClients.map(client => {
                const stage = db.funnelStages.find(s => s.id === client.stageId);
                const property = db.properties.find(p => p.id == client.propertyId);
                const propertyValue = property ? property.listPrice : client.propertyValue;
                const commission = client.commission || db.settings.defaultCommission;
                const commissionValue = (propertyValue * commission) / 100;
                return {
                    "Nome": client.name, "Contato": client.phone, "Email": client.email, "CPF": client.cpf,
                    "Data de Nascimento": client.birthdate ? formatDate(client.birthdate) : '', "Renda": client.income,
                    "Etapa do Funil": stage ? stage.name : 'N/A', "Origem do Lead": client.leadSource || 'N/A',
                    "Imóvel de Interesse": property ? property.name : '', "Valor do Imóvel (R$)": propertyValue,
                    "Comissão (%)": commission, "Valor da Comissão (R$)": commissionValue
                };
            });
            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Clientes");
            XLSX.writeFile(wb, "lista_de_clientes_filtrada.xlsx");
        });

        document.getElementById('export-properties-excel').addEventListener('click', () => {
            const dataToExport = db.properties.map(prop => ({
                "Nome do Imóvel": prop.name, "Localização": prop.location, "Valor de Tabela (R$)": prop.listPrice,
                "Valor de Avaliação (R$)": prop.evalPrice, "Data de Entrega": prop.deliveryDate ? formatDate(prop.deliveryDate) : '',
                "Link": prop.link, "Descrição": prop.description, "Diferenciais": (prop.amenities || []).join(', ')
            }));
            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Imoveis");
            XLSX.writeFile(wb, "lista_de_imoveis.xlsx");
        });
        
        // ==========================================
        // TEMPLATES DE DOCUMENTOS PDF (ATUALIZADOS)
        // ==========================================
        const getDocumentHeaderHtml = () => {
            const broker = db.settings;
            return `
                <div class="pdf-header">
                    <img src="${broker.logoUrl}" alt="Logo" class="pdf-header-logo">
                    <div class="pdf-header-info">
                        <h1>${broker.brokerName}</h1>
                        <p>${broker.brokerCreci}</p>
                        <p>Telefone: ${broker.brokerPhone}</p>
                    </div>
                </div>
            `;
        };
        
        const generateDocumentPdf = (doc) => {
            let html, filename;
            if (doc.docType === 'receipt') {
                html = getReceiptTemplate(doc);
                filename = `Recibo_${db.clients.find(c=>c.id==doc.clientId)?.name}_${doc.startDate}.pdf`;
            } else { // contract
                switch(doc.type) {
                    case 'service_sale': html = getServiceContractTemplate(doc, 'Venda'); filename = `Contrato_Servico_Venda_${db.properties.find(p=>p.id==doc.propertyId)?.name}.pdf`; break;
                    case 'service_rental': html = getServiceContractTemplate(doc, 'Locação'); filename = `Contrato_Servico_Locacao_${db.properties.find(p=>p.id==doc.propertyId)?.name}.pdf`; break;
                    case 'lease': html = getLeaseContractTemplate(doc); filename = `Contrato_Locacao_${db.properties.find(p=>p.id==doc.propertyId)?.name}.pdf`; break;
                }
            }
            if (html && filename) generatePDF(html, filename);
        };

        const getReceiptTemplate = (receipt) => {
            const client = db.clients.find(c => c.id == receipt.clientId);
            const broker = db.settings;
            return `
                <div class="pdf-document-container">
                    ${getDocumentHeaderHtml()}
                    <div class="pdf-content">
                        <h1>RECIBO</h1>
                        <div class="receipt-value-box">
                            <span class="value">${formatCurrency(receipt.value)}</span><br>
                            <span class="value-in-words">${numberToWords(receipt.value)}</span>
                        </div>
                        <p>Eu, <strong>${broker.brokerName}</strong>, inscrito(a) no CRECI sob o nº <strong>${broker.brokerCreci}</strong>, declaro para os devidos fins que recebi de <strong>${client?.name || 'N/A'}</strong>, inscrito(a) no CPF sob o nº <strong>${client?.cpf || 'N/A'}</strong>, a importância descrita acima.</p>
                        <p>O referido pagamento é referente a: <strong>${receipt.description}</strong>.</p>
                        <p>Por ser verdade, firmo o presente.</p>
                        <br><br>
                        <p class="pdf-centered-text">Maceió/AL, ${new Date(receipt.startDate + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' })}.</p>
                        <div class="pdf-signatures">
                            <div class="pdf-signature-line">
                                ${broker.brokerName}<br>
                                ${broker.brokerCreci}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const getServiceContractTemplate = (contract, serviceType) => {
            const owner = db.clients.find(c => c.id == contract.ownerId);
            const property = db.properties.find(p => p.id == contract.propertyId);
            const broker = db.settings;
            const exclusivityText = contract.exclusivity 
                ? `O presente contrato é firmado com caráter de EXCLUSIVIDADE pelo prazo de ${contract.duration * 30} dias, obrigando-se o CONTRATANTE a não tratar da ${serviceType.toLowerCase()} do imóvel, objeto deste contrato, diretamente ou através de outros corretores.`
                : `O presente contrato é firmado SEM caráter de exclusividade, podendo o CONTRATANTE tratar da ${serviceType.toLowerCase()} do imóvel diretamente ou através de outros corretores.`;

            return `
                <div class="pdf-document-container">
                    ${getDocumentHeaderHtml()}
                    <div class="pdf-content">
                        <h1>CONTRATO DE PRESTAÇÃO DE SERVIÇOS DE INTERMEDIAÇÃO IMOBILIÁRIA PARA ${serviceType.toUpperCase()}</h1>
                        <h2>DAS PARTES</h2>
                        <p><strong>CONTRATANTE:</strong> ${owner?.name}, inscrito(a) no CPF sob o nº ${owner?.cpf}, residente e domiciliado(a) em [Endereço do proprietário].</p>
                        <p><strong>CONTRATADO:</strong> ${broker.brokerName}, Corretor de Imóveis, inscrito no CRECI sob o nº ${broker.brokerCreci}, com escritório profissional em [Seu Endereço Profissional].</p>
                        <h2>DO OBJETO DO CONTRATO</h2>
                        <p>O presente contrato tem como objeto a prestação de serviços de intermediação imobiliária pelo CONTRATADO para a ${serviceType.toLowerCase()} do imóvel de propriedade do CONTRATANTE, descrito como: <strong>${property?.name}, localizado em ${property?.location}</strong>.</p>
                        <h2>DAS OBRIGAÇÕES</h2>
                        <p>O CONTRATADO se compromete a promover a divulgação do imóvel, a selecionar e apresentar potenciais interessados e a mediar as negociações. O CONTRATANTE se obriga a fornecer a documentação necessária e a pagar os honorários pactuados.</p>
                        <h2>DA REMUNERAÇÃO (HONORÁRIOS)</h2>
                        <p>Pelos serviços prestados, o CONTRATANTE pagará ao CONTRATADO, a título de honorários, o percentual de <strong>${contract.commissionRate}% (${numberToWords(contract.commissionRate)} por cento)</strong> sobre o valor total da transação.</p>
                        <h2>DO PRAZO E DA EXCLUSIVIDADE</h2>
                        <p>O prazo de vigência do presente contrato é de <strong>${contract.duration} meses</strong>.</p>
                        <p>${exclusivityText}</p>
                        <h2>DO FORO</h2>
                        <p>Fica eleito o foro da comarca de Maceió/AL para dirimir quaisquer dúvidas.</p>
                        <p class="pdf-centered-text">Maceió/AL, ${new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' })}.</p>
                        <div class="pdf-signatures">
                            <div class="pdf-signature-line">CONTRATANTE: ${owner?.name}</div>
                            <div class="pdf-signature-line">CONTRATADO: ${broker.brokerName}</div>
                        </div>
                    </div>
                </div>
            `;
        };
        
        const getLeaseContractTemplate = (contract) => {
            const owner = db.clients.find(c => c.id == contract.ownerId);
            const tenant = db.clients.find(c => c.id == contract.tenantId);
            const property = db.properties.find(p => p.id == contract.propertyId);
            return `
                 <div class="pdf-document-container">
                    ${getDocumentHeaderHtml()}
                    <div class="pdf-content">
                        <h1>CONTRATO DE LOCAÇÃO RESIDENCIAL</h1>
                        <h2>DAS PARTES</h2>
                        <p><strong>LOCADOR:</strong> ${owner?.name}, CPF nº ${owner?.cpf}.</p>
                        <p><strong>LOCATÁRIO:</strong> ${tenant?.name}, CPF nº ${tenant?.cpf}.</p>
                        <h2>DO OBJETO</h2>
                        <p>Locação do imóvel: <strong>${property?.name}</strong>, situado em <strong>${property?.location}</strong>.</p>
                        <h2>DO PRAZO</h2>
                        <p>O prazo da locação é de <strong>${contract.duration} meses</strong>, iniciando-se em ${formatDate(contract.startDate)}.</p>
                        <h2>DO VALOR DO ALUGUEL</h2>
                        <p>O valor mensal do aluguel é de <strong>${formatCurrency(contract.value)} (${numberToWords(contract.value)})</strong>, a ser pago até o 5º dia útil de cada mês.</p>
                        <p class="pdf-centered-text">Maceió/AL, ${new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' })}.</p>
                        <div class="pdf-signatures">
                            <div class="pdf-signature-line">LOCADOR: ${owner?.name}</div>
                            <div class="pdf-signature-line">LOCATÁRIO: ${tenant?.name}</div>
                        </div>
                    </div>
                </div>
            `;
        };

        // ==========================================
        // NOVAS FUNÇÕES (VÍDEO, RELATÓRIO, AÇÕES RÁPIDAS)
        // ==========================================
        const getEmbedUrl = (url) => {
            if (!url) return null;
            let videoId;
            if (url.includes('youtube.com/watch?v=')) {
                videoId = url.split('v=')[1].split('&')[0];
                return `https://www.youtube.com/embed/${videoId}`;
            }
            if (url.includes('youtu.be/')) {
                videoId = url.split('youtu.be/')[1].split('?')[0];
                return `https://www.youtube.com/embed/${videoId}`;
            }
            if (url.includes('vimeo.com/')) {
                videoId = url.split('vimeo.com/')[1].split('?')[0];
                return `https://player.vimeo.com/video/${videoId}`;
            }
            return null;
        };

        const showToast = (message) => {
            const toast = document.getElementById('quick-actions-toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        };

        modalBody.addEventListener('click', e => {
            const actionButton = e.target.closest('button[data-action]');
            if (!actionButton || currentEntityType !== 'view') return;
            
            const action = actionButton.dataset.action;
            const clientId = e.target.closest('.record-details').dataset.clientId;
            const client = db.clients.find(c => c.id == clientId);
            if (!client) return;
            
            let taskTitle = '';
            let toastMessage = '';

            if (action === 'schedule-call') {
                taskTitle = `Ligar para ${client.name}`;
                toastMessage = `Ligação para ${client.name.split(' ')[0]} agendada para amanhã!`;
            } else if (action === 'schedule-message') {
                taskTitle = `Enviar mensagem para ${client.name}`;
                toastMessage = `Mensagem para ${client.name.split(' ')[0]} agendada para amanhã!`;
            }

            if (taskTitle) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                const newEvent = {
                    id: Date.now() + Math.random(),
                    title: taskTitle,
                    clientId: client.id,
                    date: tomorrow.toISOString().slice(0, 10),
                    time: '09:00',
                    completed: false,
                    description: 'Atividade gerada automaticamente.',
                    recurrence: 'none',
                    endDate: ''
                };
                db.events.push(newEvent);
                client.lastContact = new Date().toISOString().slice(0, 10);
                saveData();
                showToast(toastMessage);
                triggerClientTableRender(); 
            }
        });
        
        document.getElementById('generate-financial-report-btn').addEventListener('click', () => {
            const reportData = { income: 0, expense: 0, balance: 0, incomeByCategory: {}, expenseByCategory: {} };
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

            db.financialRecords.forEach(record => {
                 const recordDate = new Date(record.startDate + 'T00:00:00');
                 if (recordDate >= firstDayOfMonth && recordDate <= today) {
                    if (record.type === 'income') {
                        reportData.income += record.value;
                        reportData.incomeByCategory[record.category] = (reportData.incomeByCategory[record.category] || 0) + record.value;
                    } else {
                        reportData.expense += record.value;
                        reportData.expenseByCategory[record.category] = (reportData.expenseByCategory[record.category] || 0) + record.value;
                    }
                 }
            });
            reportData.balance = reportData.income - reportData.expense;

            const categoryHtml = (categoryData) => Object.entries(categoryData)
                .sort(([,a],[,b]) => b-a)
                .map(([cat, val]) => `<li>${cat}: <strong>${formatCurrency(val)}</strong></li>`)
                .join('');

            const reportHtml = `
                <div class="report-section" id="financial-report-content">
                    <h3>Resumo do Mês Atual (${firstDayOfMonth.toLocaleDateString('pt-BR')} a ${today.toLocaleDateString('pt-BR')})</h3>
                    <div class="report-grid">
                        <div class="report-card"><div class="value" style="color:var(--success-color);">${formatCurrency(reportData.income)}</div><div class="label">Receita Total</div></div>
                        <div class="report-card"><div class="value" style="color:var(--danger-color);">${formatCurrency(reportData.expense)}</div><div class="label">Despesa Total</div></div>
                        <div class="report-card"><div class="value">${formatCurrency(reportData.balance)}</div><div class="label">Saldo</div></div>
                    </div>
                </div>
                <div class="report-section">
                    <h3>Receitas por Categoria</h3>
                    <ul>${categoryHtml(reportData.incomeByCategory) || '<li>Nenhuma receita este mês.</li>'}</ul>
                </div>
                <div class="report-section">
                    <h3>Despesas por Categoria</h3>
                    <ul>${categoryHtml(reportData.expenseByCategory) || '<li>Nenhuma despesa este mês.</li>'}</ul>
                </div>
            `;
            const modalBodyHtml = `
                ${reportHtml}
                <div class="modal-footer" style="display:flex; justify-content: flex-end; margin-top: 1rem;">
                    <button class="btn-primary" id="print-report-btn"><i class="fas fa-print"></i> Imprimir Relatório</button>
                </div>`;

            openModal('Relatório Financeiro Mensal', modalBodyHtml, 'report', null, false);
            
            document.getElementById('print-report-btn').addEventListener('click', () => {
                const reportContent = document.getElementById('financial-report-content').innerHTML;
                printContent(reportContent, 'Relatório Financeiro Mensal');
            });
        });

        // ==========================================
        // INICIALIZAÇÃO DO SISTEMA
        // ==========================================
        const init = async () => {
            await loadData();
            updateHeader();
            switchPanel('dashboard');
            setTimeout(checkStartupAlerts, 10000);
        };
    
        init();
    });
    </script>
</body>
</html>
